@page "/order/ordersfortodaytomorrow"
@inject IJSRuntime jsRuntime

@using Microsoft.AspNetCore.Authorization
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Notifications
@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Spinner
@using HashtilERP.Shared.Models
@using Syncfusion.Blazor.Inputs
@using Microsoft.AspNetCore.SignalR.Client
@using Syncfusion.Blazor.Navigations
@using Syncfusion.Blazor.Data
@using Syncfusion.Blazor.Calendars
@using Syncfusion.Blazor.SplitButtons
@using System.Timers;
@using HashtilERP.Shared.Models.Drivers;
@using HashtilERP.Shared.Models.Mobile;

@inject NavigationManager NavigationManager
@inject HttpClient Http



@attribute [Authorize(Roles = "Administrator,Viewer,Manager-GreenHouse,Agronomist,AuditAvgCounter,Manager-Oren,Sales-A,Sales-B,Manager-Drivers")]
<div style="text-align:right" class="alert alert-primary" role="alert">
    <h2 style="text-align:center">הוצאות להיום/מחר</h2>
</div>
<AuthorizeView Roles="Administrator">
    <button class="btn btn-success" @onclick="BtnSemdMultiJobIsDone">מוכנה</button>
    <br />
</AuthorizeView>

@*Select Driver For Drivers-Manager*@
<AuthorizeView Roles="Manager-Drivers">
    <div class="row">
        <div class="col" style="text-align:right">
            <div class="alert alert-secondary" role="alert">

                <div class="row" style="text-align:right;">
                    <div class="col">
                        <SfDropDownList TValue="string" Width="200px" TItem="Driver" DataSource="@Drivers" @bind-Value="@DriverId" Placeholder="בחר נהג">
                            <DropDownListFieldSettings Text="FullName" Value="DriverId"></DropDownListFieldSettings>
                        </SfDropDownList>
                        <button class="btn btn-outline-success" @onclick="SendDriverToOrder">שליחה</button>
                    </div>
                </div>
            </div>
        </div>


    </div>

</AuthorizeView>

@*Multi AVG for rows Auth for Admin, Green Mnagr & Oren*@
<AuthorizeView Roles="Administrator,Manager-GreenHouse,Manager-Oren">
    <div class="row">
        <div class="col" style="text-align:right">
            <div class="alert alert-secondary" role="alert">

                <div class="row" style="text-align:right;">
                    <div class="col">
                        <input type="number" style="width:150px" @bind-value="@MultiAVGInput" placeholder="ממוצע" />
                        <button class="btn btn-outline-success" @onclick="BtnSendMultiAVG">שליחה</button>
                    </div>
                    <div class="col">
                        <SfDatePicker TValue="DateTime?" @bind-Value="@MultiDate" EnableRtl="true" Width="200px" Placeholder='שינוי ת.הוצאה'></SfDatePicker>
                        <button class="btn btn-outline-warning" @onclick="BtnSendMultiDate">שליחה</button>
                    </div>
                    <div class="col" style="text-align:left">
                        <button class="btn btn-outline-danger" @onclick="BtnCancelJobs">ביטול עבודה</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col" style="text-align:left">
            <SfProgressButton Content="שליחה להדפסה" CssClass="e-outline e-success" @onclick="@(_ => {SentToBartenderPrint(0);})">
                <ProgressButtonSpinSettings Position="SpinPosition.Right"></ProgressButtonSpinSettings>
            </SfProgressButton>
            <SfProgressButton Content="ביטול הדפסה" CssClass="e-outline e-danger" @onclick="@(_ => {SentToBartenderPrint(1);})">
                <ProgressButtonSpinSettings Position="SpinPosition.Left"></ProgressButtonSpinSettings>
            </SfProgressButton>
        </div>
    </div>

</AuthorizeView>

<AuthorizeView Roles="Sales-A, Sales-B">
    <div class="row">
        <div class="col" style="text-align:right">
            <div class="alert alert-secondary" role="alert">

                <div class="row" style="text-align:right;">
                    <div class="col">
                        <SfDatePicker TValue="DateTime?" @bind-Value="@MultiDate" EnableRtl="true" Width="200px" Placeholder='שינוי ת.הוצאה'></SfDatePicker>
                        <button class="btn btn-outline-warning" @onclick="BtnSendMultiDate">שליחה</button>
                    </div>
                    <div class="col" style="text-align:left">
                        <button class="btn btn-outline-danger" @onclick="BtnCancelJobs">ביטול עבודה</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col" style="text-align:left">
            <SfProgressButton Content="יצאה תעודה" CssClass="e-outline e-success" @onclick="@(_ => {SetIsDeliveryNote(0);})">
                <ProgressButtonSpinSettings Position="SpinPosition.Right"></ProgressButtonSpinSettings>
            </SfProgressButton>
            <SfProgressButton Content="ביטול תעודה" CssClass="e-outline e-danger" @onclick="@(_ => {SetIsDeliveryNote(1);})">
                <ProgressButtonSpinSettings Position="SpinPosition.Left"></ProgressButtonSpinSettings>
            </SfProgressButton>
        </div>
    </div>

</AuthorizeView>

@if (K_Orders == null)
{
    <div class="col-sm">
        <div class="spin-row">
            <SfSpinner Size="40" Label="מייבא נתונים..." Type="SpinnerType.Bootstrap4" Visible="true" CssClass="e-customClass"></SfSpinner>
        </div>
    </div>
}

@*Spinner*@
<div class="col-sm">
    <div class="spin-row">
        <SfSpinner Size="40" Label="טוען..." Type="SpinnerType.Bootstrap4" Visible="@LoadingSpinner" CssClass="e-customClass"></SfSpinner>
    </div>
</div>


@{
    var Tool = (new List<string>() { "Search" });
}
<div>
    <button class="btn btn-primary" @onclick="BtnOpenNewJobForm">עבודה חדשה</button>
</div>

@*Clear search and filter Btns*@
<div class="row">
    <div class="col" style="text-align:left">
        <button class="btn btn-info"
                type="button"
                @onclick="ClearGridfilter">
            הסר מסנן
        </button>
        <button class="btn btn-warning"
                type="button"
                @onclick="ClearGridSearch">
            ניקוי חיפוש
        </button>
        <button class="btn btn-warning"
                type="button"
                @onclick="SendPassportPost">
            dd
        </button>
    </div>

</div>

@*Alert/Error message Dialog*@
<SfDialog Width="250px" IsModal="true" @bind-Visible="@ErrorDialogIsVisible" EnableRtl="true">
    <DialogEvents OnOverlayClick="@OnOverlayclick">
    </DialogEvents>
    <DialogTemplates>
        <Header>@ErrorModalHeaderContent</Header>
        <Content> @ModalError </Content>
    </DialogTemplates>
    <DialogButtons>
        <DialogButton Content="אישור" IsPrimary="true" OnClick="@CloseDialog" />

    </DialogButtons>
</SfDialog>

@*Grid No.1*@
<SfGrid DataSource="@GridNo1List" FrozenRows="0" Height="800" Width="100%" @ref="@SfGrid"
        AllowFiltering="true" Toolbar=@Tool EnableRtl="true"
        AllowGrouping="false" AllowSorting="true" AllowSelection="true" AllowPaging="true">
    <GridSelectionSettings CheckboxOnly="true" Type="Syncfusion.Blazor.Grids.SelectionType.Multiple"></GridSelectionSettings>
    <GridEvents QueryCellInfo="CustomizeCell" OnRecordDoubleClick="RecordDoubleClickHandler" TValue="K_Order"
                CommandClicked="OnCommandClicked" RowSelected="RowSelected" RowDeselected="RowDeSelected" RowDataBound="RowBound"></GridEvents>
    <GridEditSettings AllowAdding="true" AllowEditing="false" AllowDeleting="true" Mode="EditMode.Dialog"></GridEditSettings>
    <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel"></GridFilterSettings>
    <GridPageSettings PageSize="30"></GridPageSettings>
    <GridAggregates>
        <GridAggregate>
            <GridAggregateColumns>
                <GridAggregateColumn Field=@nameof(K_Order.CxName) Type="AggregateType.Count">
                    <FooterTemplate>
                        @{
                            var aggregate = (context as AggregateTemplateContext);

                            <b>ספירה: @aggregate.Count</b>

                        }
                    </FooterTemplate>
                </GridAggregateColumn>
                <GridAggregateColumn Field=@nameof(K_Order.JobNumOfMagash) Type="AggregateType.Sum">
                    <FooterTemplate>
                        @{
                            var aggregate = (context as AggregateTemplateContext);

                            var num = Convert.ToInt32(aggregate.Sum);
                            var magashNum = string.Format("{0:#,0}", num);
                            <b>@magashNum</b>

                        }
                    </FooterTemplate>
                </GridAggregateColumn>
                <GridAggregateColumn Field=@nameof(K_Order.JobPlantsNum) Type="AggregateType.Sum">
                    <FooterTemplate>
                        @{
                            var aggregate = (context as AggregateTemplateContext);

                            var num = Convert.ToInt32(aggregate.Sum);
                            var plantsNum = string.Format("{0:#,0}", num);
                            <b>@plantsNum</b>
                        }
                    </FooterTemplate>
                </GridAggregateColumn>
            </GridAggregateColumns>
        </GridAggregate>

    </GridAggregates>
    <GridColumns>
        <GridColumn Field=@nameof(K_Order.JobId) HeaderText="" HeaderTextAlign="TextAlign.Center" Type="ColumnType.Number" IsPrimaryKey="true" Visible="false" TextAlign="TextAlign.Center"></GridColumn>
        <GridColumn Type="ColumnType.CheckBox" HeaderTextAlign="TextAlign.Center" Width="50"></GridColumn>
        <GridColumn Field=@nameof(K_Order.MarketingDateDate) HeaderText="ת.הוצאה" HeaderTextAlign="TextAlign.Center" Format="d" Type="ColumnType.Date" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.HebrewDayName) HeaderText="יום" AllowEditing="false" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.DriverName) HeaderText="נהג" AllowEditing="false" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.CxName) HeaderText="לקוח" AllowEditing="false" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.Gidul) HeaderText="גידול" AllowEditing="false" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.Zan) HeaderText="זן" AllowEditing="false" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.JobStatus) HeaderText="סטטוס" AllowEditing="false" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.JobPlantsNum) HeaderText="כ.שתילים" HeaderTextAlign="TextAlign.Center" Format="N0" Type="ColumnType.Number" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.JobNumOfMagash) HeaderText="כ.מגשים" HeaderTextAlign="TextAlign.Center" Format="N0" Type="ColumnType.Number" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.JobPlansAvarage) HeaderText="ממוצע" HeaderTextAlign="TextAlign.Center" Format="N0" Type="ColumnType.Number" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.HamamaRemarks) HeaderText="הערות מנהל עבודה" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.DeliveryRemarks) HeaderText="הערות הובלה" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.PassprodComments) HeaderText="הערות נוספות" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.AnotherFixedRemarks) HeaderText="הערות קבועות" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <AuthorizeView Roles="Administrator,Manager-GreenHouse,Manager-Oren">
            <GridColumn HeaderText="" TextAlign="TextAlign.Center">
                <GridCommandColumns>
                    <GridCommandColumn Type=CommandButtonType.None
                                       ButtonOption="@(new CommandButtonOptions() { Content = "בחירת פספורט", CssClass = "e-info" })">
                    </GridCommandColumn>
                </GridCommandColumns>
            </GridColumn>
        </AuthorizeView>
        <GridColumn Field=@nameof(K_Order.GetIsJobDeliveryOut) HeaderText="ת.משלוח" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center"></GridColumn>
    </GridColumns>
</SfGrid>

@*Edit Row Dialog*@
<SfDialog Target="#target" EnableRtl="true"
          Width="800px"
          Height="800px"
          @bind-Visible="@RowEditDialogShow" ShowCloseIcon="true" IsModal="true">

    <DialogTemplates>
        <Content>
            <div class="row">
                <div class="col">
                    <button class="btn btn-warning" @onclick="@ShowKorderRemark">הערה</button>
                </div>
                <div class="col">
                    <AuthorizeView Roles="Administrator">
                        @{if (K_OrderForEdit.JobStatus == K_OrderPhase.Finish)
                            {
                                <button class="btn btn-outline-primary" @onclick="@ShowKorderReturn">החזרה</button>
                            }
                        }
                    </AuthorizeView>
                </div>
                <div class="col" style="text-align:left">
                    @{if (K_OrderForEdit.IsJobCancel == true)
                        {
                            if (K_OrderForEdit.K_OrderPassports.Count() > 0)
                            {
                                <AuthorizeView Roles="Administrator, Manager-GreenHouse">
                                    <button class="btn btn-primary" style="text-align:left" @onclick="@(_ => { DeletePassAndCancelJob(); })">מחיקה ואישור</button>
                                </AuthorizeView>
                            }
                            <button class="btn btn-outline-info" style="text-align:left" @onclick="@(_ => { SetJobIsCancelFalse(); })">יוצאת</button>
                        }
                        else if (K_OrderForEdit.JobStatus != K_OrderPhase.Canceled)
                        {
                            <AuthorizeView Roles="Administrator, Manager-GreenHouse,Manager-Oren,Sales-A,Sales-B">
                                <button class="btn btn-danger" style="text-align:left" @onclick="@KorderCancelShow">ביטול עבודה</button>
                            </AuthorizeView>
                        }
                    }
                    @{ if (K_OrderForEdit.WasEditAfterAttachedPassports == true)
                        {
                            <AuthorizeView Roles="Administrator, Manager-GreenHouse">
                                <button class="btn btn-dark" style="text-align:left" @onclick="@KorderConfirmEdit">אישור עריכה</button>
                            </AuthorizeView>
                        }
                    }
                </div>
            </div>
            <hr>
            <SfTab HeaderPlacement="HeaderPosition.Top">
                <TabItems>
                    <TabItem>
                        <ChildContent>
                            <TabHeader Text="ראשי"></TabHeader>
                        </ChildContent>
                        <ContentTemplate>
                            <br />
                            <div class="container" @onmouseup="CheckGidulForEdit">
                                <div class="form-group">
                                    <div style="text-align:right" class="alert alert-success" role="alert">
                                        <div class="row">
                                            <h5 style="text-align:center">לקוח: @K_OrderForEdit.CxName</h5>
                                        </div>
                                        <div class="row">
                                            <h5>גידול: @K_OrderForEdit.Gidul</h5>
                                        </div>
                                        <div class="row">
                                            <h5>זן: @K_OrderForEdit.Zan</h5>
                                        </div>
                                        <div class="row">
                                            <h5>ת.הוצאה: @DateTimeToShortString(K_OrderForEdit.MarketingDate),@KOrderAlgorithemShared.GetHebrewDayOfTheWeek(K_OrderForEdit.MarketingDate)</h5>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col">
                                            <div class="form-group">
                                                <label>בחירת תאריך</label>
                                                <SfDatePicker TValue="DateTime?" EnableRtl="true" @bind-Value="@K_OrderForEdit.MarketingDate" Placeholder='תאריך הוצאה'></SfDatePicker>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="form-group">
                                                <label>בחירת לקוח</label>
                                                <SfAutoComplete TValue="string" TItem="string" Placeholder="בחירת לקוח" @bind-Value="@K_OrderForEdit.CxName" DataSource="@DropDownKOrderSapCxNames">
                                                    <AutoCompleteFieldSettings Value="CxName"></AutoCompleteFieldSettings>
                                                </SfAutoComplete>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <div class="form-group">
                                                <label>בחירת גידול</label>
                                                <SfAutoComplete TValue="string" TItem="string" Placeholder="גידול" @onmousedown="@(e => EditGidulMouseClick(e))" @bind-Value="@K_OrderForEdit.Gidul" DataSource="@Giduls">
                                                </SfAutoComplete>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="form-group">
                                                <label>בחירת זן</label>
                                                <SfAutoComplete TValue="string" TItem="string" Placeholder="זן" @onmousedown="@(e => EditZanMouseClick(e))" @bind-Value="@K_OrderForEdit.Zan" DataSource="@Zans">
                                                </SfAutoComplete>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <div class="form-group">
                                                <label>כ.שתילים</label>
                                                <SfNumericTextBox TValue="int?" Step="100" @bind-Value="K_OrderForEdit.JobPlantsNum" Format="n0" Placeholder="שתילים"></SfNumericTextBox>
                                                @*<input type="number" @bind-value="K_OrderForEdit.JobPlantsNum" class="form-control" placeholder="שתילים" />*@
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="form-group">
                                                <label>כ.מגשים</label>
                                                @*<input type="number" @bind-value="K_OrderForEdit.JobNumOfMagash" class="form-control" placeholder="מגשים" />*@
                                                <SfNumericTextBox TValue="int?" @bind-Value="K_OrderForEdit.JobNumOfMagash" Format="n0" Placeholder="מגשים"></SfNumericTextBox>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <div class="form-group">
                                                <label>ממוצע</label>
                                                @*<input type="number" @bind-value="K_OrderForEdit.JobPlansAvarage" max="999" @onkeydown="EditOrderKeyDown" class="form-control" placeholder="ממוצע" />*@
                                                <SfNumericTextBox TValue="int?" @bind-Value="K_OrderForEdit.JobPlansAvarage" @onkeydown="EditOrderKeyDown" Format="n0" Placeholder="ממוצע"></SfNumericTextBox>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="row">
                                                <label>כ.שתילים: @AutoPlantsCalc</label>
                                            </div>
                                            <div class="row">
                                                <label>מגשים: @K_OrderForEdit.JobNumOfMagash</label>
                                            </div>
                                            <div class="row">
                                                <label>ממוצע לחישוב: @AVGAutoCalc</label>
                                            </div>
                                        </div>
                                    </div>
                                    @*check box*@
                                    <div class="form-group">
                                        <div class="alert alert-warning" role="alert">
                                            <label>לסמן את הרלוונטי</label>
                                            <div class="row">
                                                <div class="col">
                                                    <div>
                                                        <SfCheckBox @bind-Checked="@K_OrderForEdit.IsCageSmall" EnableRtl="true" Label="כלובים קטנים"></SfCheckBox>
                                                    </div>
                                                    <div>
                                                        <SfCheckBox @bind-Checked="@K_OrderForEdit.IsCxComeToPickUp" EnableRtl="true" Label="מגיע לקחת"></SfCheckBox>
                                                    </div>
                                                </div>
                                                <div class="col">
                                                    <div>
                                                        <SfCheckBox @bind-Checked="@K_OrderForEdit.IsNeedToConfirmJob" EnableRtl="true" Label="לוודא הוצאה"></SfCheckBox>
                                                    </div>
                                                    <div>
                                                        <SfCheckBox @bind-Checked="@K_OrderForEdit.IsTakeoutJobTomorrow" EnableRtl="true" Label="להוציא מחר"></SfCheckBox>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>הערות הובלה</label>
                                        <SfTextBox Multiline=true EnableRtl="true" Placeholder="הערות הובלה" @bind-value="K_OrderForEdit.DeliveryRemarks"></SfTextBox>
                                    </div>
                                    <div class="form-group">
                                        <label>הערות לחממה</label>
                                        <div class="multiline">
                                            <SfTextBox Multiline=true EnableRtl="false" Placeholder="הערות למנהל עבודה" @bind-value="K_OrderForEdit.HamamaRemarks"></SfTextBox>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">

                                        </div>
                                        <div class="col">

                                        </div>
                                    </div>
                                </div>
                            </div>

                        </ContentTemplate>
                    </TabItem>
                    <TabItem>
                        <ChildContent>
                            <TabHeader Text="פרטים נוספים"></TabHeader>
                        </ChildContent>
                        <ContentTemplate>
                            @{if (K_OrderForEdit.K_OrderPassports.Count > 0)
                                {
                                    <div class="alert alert-primary" style="text-align:right" role="alert">
                                        <h4 class="alert-heading">פספורטים מצוותים</h4>
                                        <hr>
                                        <table class="table table-striped table-hover" style="text-align:right;width:auto">
                                            <thead>
                                                <tr>
                                                    <th>
                                                        פספורט
                                                    </th>
                                                    <th>
                                                        חממה
                                                    </th>
                                                    <th>
                                                        גמלון
                                                    </th>
                                                    <th>
                                                        מגשים
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var kpassport in K_OrderForEdit.K_OrderPassports)
                                                {
                                                    <tr>
                                                        <td style="font-size:14px;font-weight:bold">
                                                            @kpassport.K_PassportNum
                                                        </td>
                                                        <td style="font-size:14px;font-weight:bold">
                                                            @kpassport.K_Passport.Hamama
                                                        </td>
                                                        <td style="font-size:14px;font-weight:bold">
                                                            @kpassport.K_Passport.Gamlon
                                                        </td>
                                                        <td style="font-size:14px;font-weight:bold">
                                                            @kpassport.PassportMagashAmpunt
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                        @{
                                            var magashDelta = K_OrderForEdit.K_OrderPassports.Sum(x => x.PassportMagashAmpunt) - K_OrderForEdit.JobNumOfMagash;
                                            if (magashDelta > 0)
                                            {<div class="alert alert-success" style="text-align:right" role="alert">
                                                    <h5>לתשומת לבך! יש עודף של @magashDelta מגשים</h5>
                                                </div> }
                                            if (magashDelta < 0)
                                            {
                                                magashDelta *= -1;
                                                <div class="alert alert-danger" style="text-align:right" role="alert">
                                                    <h5>לתשומת לבך! יש חוסר של @magashDelta מגשים</h5>
                                                </div> }
                                        }
                                    </div>

                                }
                                else
                                {
                                    <div style="text-align:right" class="alert alert-warning" role="alert">
                                        <h3>
                                            לא צוותו פספורטים
                                        </h3>
                                    </div>
                                }
                            }
                            <div class="alert alert-success" style="text-align:right" role="alert">
                                <table class="table table-striped table-hover" style="text-align:right;width:auto">
                                    <thead>
                                        <tr>
                                            <th>
                                                תאריך
                                            </th>
                                            <th>
                                                נוספה ע"י
                                            </th>
                                            <th>
                                                הערה
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>

                                        @foreach (var form in K_OrderForEdit.k_OrderRemarks.OrderByDescending(x => x.K_OrderRemarkStamp))
                                        {

                                            <tr>
                                                <td style="font-size:14px;font-weight:bold">
                                                    @form.K_OrderRemarkStamp
                                                </td>
                                                <td style="font-size:14px;font-weight:bold">
                                                    @form.UserName
                                                </td>
                                                <td style="font-size:14px;font-weight:bold">
                                                    @form.Remark
                                                </td>
                                            </tr>

                                        }
                                    </tbody>
                                </table>
                            </div>
                        </ContentTemplate>
                    </TabItem>
                    <TabItem>
                        <ChildContent>
                            <TabHeader Text="היסטוריית עריכה"></TabHeader>
                        </ChildContent>
                        <ContentTemplate>
                            @{
                                <table class="table table-striped table-hover" style="text-align:right;width:auto">
                                    <thead>
                                        <tr>
                                            <th>
                                                תאריך
                                            </th>
                                            <th>
                                                נערכה ע"י
                                            </th>
                                            <th>
                                                תיאור
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var updateAudit in K_OrderForEdit.k_OrderAuditTables.OrderByDescending(x => x.Date))
                                        {

                                            <tr>
                                                <td>
                                                    @updateAudit.Date
                                                </td>
                                                <td>
                                                    @updateAudit.UserName
                                                </td>
                                                <td>
                                                    @updateAudit.AuditString
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            }
                        </ContentTemplate>
                    </TabItem>
                </TabItems>
            </SfTab>


        </Content>

        <FooterTemplate>
            <AuthorizeView Roles="Administrator,Manager-GreenHouse,Sales-A,Sales-B,Manager-Oren">
                <div class="row text-center">
                    <div class="col">
                        <button class="btn btn-success" @onclick="@(_ => { SendRowEdit(K_OrderForEdit); })">אישור</button>
                    </div>
                    <div class="col">
                        <button class="btn btn-danger" @onclick="@CancelRowEditDialogShow">ביטול</button>
                    </div>
                </div>
            </AuthorizeView>
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>


@*KOrder RETURN Dialog*@
<SfDialog Target="#target" EnableRtl="true"
          Width="350"
          Height="400"
          @bind-Visible="@KOrderReturnShow" ShowCloseIcon="true" IsModal="true">
    <DialogTemplates>
        <Header>
            <div style="text-align:right" class="alert alert-secondary" role="alert">
                <h4 style="text-align:center">עבודה שחזרה</h4>
            </div>
        </Header>
        <Content>
            <div class="form-group">
                <label style="font-size:16px;font-weight:bold">סיבת החזרה(לנסות לדייק)</label>
                <SfTextBox Multiline=true EnableRtl="true" Placeholder="סיבת החזרה" @bind-value="WhyKOrderWasReturn"></SfTextBox>
                <br />
                <br />
                <label style="font-size:16px;font-weight:bold">כמות מגשים שחזרה</label>
                <input type="number" class="form-control" style="width:auto" @bind-value="K_OrderForEdit.JobNumOfMagash" />
            </div>
        </Content>
        <FooterTemplate>
            <button class="btn btn-success" @onclick="SendOrderReturn">שליחה</button>
            <button class="btn btn-danger" @onclick="KOrderReturnHide">ביטול</button>
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>


@*KOrder Job Cancel Dialog*@
<SfDialog Target="#target" EnableRtl="true"
          Width="350"
          Height="350"
          @bind-Visible="@CancelKorderShow" ShowCloseIcon="false" IsModal="true">
    <DialogTemplates>
        <Content>
            <div>
                <label style="font-size:16px;font-weight:bold" for="plantsinput">מי ביטל?</label>
                <SfDropDownList TValue="string" TItem="string" enab DataSource="@KorderCancelWhoCancelList" @bind-Value="@WhoCancel" Placeholder=""></SfDropDownList>
                <label style="font-size:16px;font-weight:bold" for="plantsinput">סיבת ביטול(קצר)</label>
                <SfTextBox Multiline=true EnableRtl="true" Placeholder="סיבה" @bind-value="TboxCancel"></SfTextBox>
            </div>
        </Content>
        <FooterTemplate>
            <div class="row">
                <div class="col" style="text-align:right">
                    @{if (IsListOfCancelJobs == true)
                        {
                            <button class="btn btn-success" @onclick="SencListJobsCancel">שליחה</button>
                        }
                        else
                        {
                            <button class="btn btn-success" @onclick="SendOrderCancelForm">שליחה</button>
                        }
                    }
                </div>
                <div class="col">
                    <button class="btn btn-danger" @onclick="KorderCancelHide">ביטול</button>
                </div>
            </div>

        </FooterTemplate>
    </DialogTemplates>
</SfDialog>


@*KOrder Remark Dialog*@
<SfDialog Target="#target" EnableRtl="true"
          Width="200"
          Height="200"
          @bind-Visible="@KOrderRemarkShow" ShowCloseIcon="true" IsModal="true">
    <DialogTemplates>
        <Content>
            <div>
                <SfTextBox Multiline=true EnableRtl="true" Placeholder="הערה חדשה" @bind-value="K_OrderRemark.Remark"></SfTextBox>
            </div>
        </Content>
        <FooterTemplate>
            <button class="btn btn-success" @onclick="SendOrderRemark">שליחה</button>
            <button class="btn btn-danger" @onclick="KOrderRemarkHide">ביטול</button>
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>
<br />
<div style="text-align:right" class="alert alert-danger" role="alert">
    <h2 style="text-align:center">עבודות לוודא/להוציא מחר</h2>
</div>
@*GRID No. 2*@
<SfGrid DataSource="@NeedToConfirmRecords" FrozenRows="0" Height="100" Width="100%" @ref="@SfGridNo2"
        AllowFiltering="true" Toolbar=@Tool EnableRtl="true"
        AllowGrouping="false" AllowSorting="true" AllowSelection="true">
    <GridEvents OnRecordDoubleClick="RecordDoubleClickHandler" TValue="K_Order"
                RowDataBound="RowBound"></GridEvents>
    <GridEditSettings AllowAdding="true" AllowEditing="false" AllowDeleting="true" Mode="EditMode.Dialog"></GridEditSettings>
    <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel"></GridFilterSettings>
    <GridAggregates>
        <GridAggregate>
            <GridAggregateColumns>
                <GridAggregateColumn Field=@nameof(K_Order.CxName) Type="AggregateType.Count">
                    <FooterTemplate>
                        @{
                            var aggregate = (context as AggregateTemplateContext);

                            <b>ספירה: @aggregate.Count</b>

                        }
                    </FooterTemplate>
                </GridAggregateColumn>
                <GridAggregateColumn Field=@nameof(K_Order.JobNumOfMagash) Type="AggregateType.Sum">
                    <FooterTemplate>
                        @{
                            var aggregate = (context as AggregateTemplateContext);

                            <b>@aggregate.Sum</b>

                        }
                    </FooterTemplate>
                </GridAggregateColumn>
                <GridAggregateColumn Field=@nameof(K_Order.JobPlantsNum) Type="AggregateType.Sum">
                    <FooterTemplate>
                        @{
                            var aggregate = (context as AggregateTemplateContext);

                            <b>@aggregate.Sum</b>

                        }
                    </FooterTemplate>
                </GridAggregateColumn>
            </GridAggregateColumns>
        </GridAggregate>

    </GridAggregates>
    <GridColumns>
        <GridColumn Field=@nameof(K_Order.JobId) HeaderText="" HeaderTextAlign="TextAlign.Center" Type="ColumnType.Number" IsPrimaryKey="true" Visible="false" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.MarketingDateDate) HeaderText="ת.הוצאה" HeaderTextAlign="TextAlign.Center" Format="d" Type="ColumnType.Date" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.CxName) HeaderText="לקוח" AllowEditing="false" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.Gidul) HeaderText="גידול" AllowEditing="false" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.Zan) HeaderText="זן" AllowEditing="false" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.JobPlantsNum) HeaderText="כ.שתילים" HeaderTextAlign="TextAlign.Center" Format="N0" Type="ColumnType.Number" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.JobNumOfMagash) HeaderText="כ.מגשים" HeaderTextAlign="TextAlign.Center" Format="N0" Type="ColumnType.Number" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.JobPlansAvarage) HeaderText="ממוצע" HeaderTextAlign="TextAlign.Center" Format="N0" Type="ColumnType.Number" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.HamamaRemarks) HeaderText="הערות מנהל עבודה" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.DeliveryRemarks) HeaderText="הערות הובלה" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center" AutoFit="true"></GridColumn>
        <GridColumn Field=@nameof(K_Order.AnotherFixedRemarks) HeaderText="הערות קבועות" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center"></GridColumn>
    </GridColumns>
</SfGrid>

@*New Job Form Dialog*@
<SfDialog Target="#target" EnableRtl="true"
          Width="400px"
          Height="700px"
          @bind-Visible="@NewJobFormIsVisible" ShowCloseIcon="false" IsModal="true">

    <DialogTemplates>
        <Header>
            <div class="alert alert-success" role="alert">
                <h4 style="text-align:center">עבודה חדשה</h4>
            </div>
        </Header>
        <Content>
            <form @onmouseup="CheckGidul">
                <div class="form-group">
                    <label>בחירת תאריך</label>
                    <SfDatePicker TValue="DateTime?" @bind-Value='@DateValue' EnableRtl="true" Placeholder='תאריך הוצאה'></SfDatePicker>
                </div>
                <div class="form-group">
                    <label>בחירת לקוח</label>
                    <SfAutoComplete TValue="string" TItem="string" Placeholder="בחירת לקוח" @bind-Value="@NewJobK_Order.CxName" DataSource="@DropDownKOrderSapCxNames">
                        <AutoCompleteFieldSettings Value="CxName"></AutoCompleteFieldSettings>
                    </SfAutoComplete>
                </div>
                <div class="form-group">
                    <label>בחירת גידול</label>
                    <SfAutoComplete TValue="string" TItem="string" Placeholder="גידול" @onmousedown="@(e => GidulMouseClick(e))" @bind-Value="@NewJobK_Order.Gidul" DataSource="@Giduls">
                    </SfAutoComplete>
                </div>
                <div class="form-group">
                    <label>בחירת זן</label>
                    <SfAutoComplete TValue="string" TItem="string" Placeholder="זן" @onmousedown="@(e => ZanMouseClick(e))" @bind-Value="@NewJobK_Order.Zan" DataSource="@Zans">
                    </SfAutoComplete>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label>כ.שתילים</label>
                            <SfNumericTextBox TValue="int?" Step="100" @bind-Value="NewJobK_Order.JobPlantsNum" Format="n0" Placeholder="שתילים"></SfNumericTextBox>
                            @*<input type="number" @bind-value="NewJobK_Order.JobPlantsNum" class="form-control" placeholder="שתילים" />*@
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label>כ.מגשים</label>
                            @*<input type="number" @bind-value="NewJobK_Order.JobNumOfMagash" class="form-control" placeholder="מגשים" />*@
                            <SfNumericTextBox TValue="int?" @bind-Value="NewJobK_Order.JobNumOfMagash" Format="n0" Placeholder="מגשים"></SfNumericTextBox>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label>ממוצע</label>
                            @*<input type="number" @bind-value="NewJobK_Order.JobPlansAvarage" max="999" @onkeydown="KeyDown" class="form-control" placeholder="ממוצע" />*@
                            <SfNumericTextBox TValue="int?" @bind-Value="NewJobK_Order.JobPlansAvarage" @onkeydown="KeyDown" Format="n0" Placeholder="ממוצע"></SfNumericTextBox>
                        </div>
                    </div>
                    <div class="col">
                        <div class="row">
                            <label>כ.שתילים: @AutoPlantsCalc</label>
                        </div>
                        <div class="row">
                            <label>מגשים: @AutoMagashCalc</label>
                        </div>
                        <div class="row">
                            <label>ממוצע לחישוב: @AVGAutoCalc</label>
                        </div>
                    </div>
                </div>
                @*<div class="form-group">
                        <div class="alert alert-danger" role="alert">
                            <label>כ.כלובים (רק אם רלוונטי!)</label>
                            <input type="number" @bind-value="NewJobK_Order.NumOfCages" class="form-control" placeholder="כ.כלובים" />
                        </div>
                    </div>*@

                @*check box*@
                <div class="form-group">
                    <div class="alert alert-warning" role="alert">
                        <label>לסמן את הרלוונטי</label>
                        <div class="row">
                            <div class="col">
                                <div>
                                    <SfCheckBox @bind-Checked="@NewJobK_Order.IsCageSmall" EnableRtl="true" Label="כלובים קטנים"></SfCheckBox>
                                </div>
                                <div>
                                    <SfCheckBox @bind-Checked="@NewJobK_Order.IsCxComeToPickUp" EnableRtl="true" Label="מגיע לקחת"></SfCheckBox>
                                </div>
                            </div>
                            <div class="col">
                                <div>
                                    <SfCheckBox @bind-Checked="@NewJobK_Order.IsNeedToConfirmJob" EnableRtl="true" Label="לוודא הוצאה"></SfCheckBox>
                                </div>
                                <div>
                                    <SfCheckBox @bind-Checked="@NewJobK_Order.IsTakeoutJobTomorrow" EnableRtl="true" Label="להוציא מחר"></SfCheckBox>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>הערות הובלה</label>
                    <SfTextBox Multiline=true EnableRtl="true" Placeholder="הערות הובלה" @bind-value="NewJobK_Order.DeliveryRemarks"></SfTextBox>
                </div>
                <div class="form-group">
                    <label>הערות לחממה</label>
                    <div class="multiline">
                        <SfTextBox Multiline=true EnableRtl="false" Placeholder="הערות למנהל עבודה" @bind-value="NewJobK_Order.HamamaRemarks"></SfTextBox>
                    </div>
                </div>

            </form>
        </Content>
        <FooterTemplate>
            <div class="row text-center">
                <AuthorizeView Roles="Administrator,Sales-A,Sales-B,Manager-GreenHouse,Manager-Oren,Manager-Drivers">
                    <div class="col">
                        <button class="btn btn-success" @onclick="@(_ => { BtnSendNewJob(NewJobK_Order); })">שליחה</button>
                    </div>
                    <div class="col">
                        <button class="btn btn-outline-info" @onclick="@(_ => { BtnAddAnotherJobToCx(); })">שליחה +</button>
                    </div>
                </AuthorizeView>
                <div class="col">
                    <button class="btn btn-danger" @onclick="@NewJobCloseForm">ביטול</button>
                </div>
            </div>
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>

@*Toast Component*@
<SfToast @ref="ToastObj" ID="toast_default" Title="" Timeout=3000 Icon="e-meeting" EnableRtl="true" Content="@ToastContent">
    <ToastPosition X="Center"></ToastPosition>
</SfToast>

@*Pick Passports Modal*@
<SfDialog Target="#target" EnableRtl="true"
          Width="95%"
          Height="90%"
          @bind-Visible="@PickPassForKorderModalBool" ShowCloseIcon="true" IsModal="true">

    <DialogTemplates>
        <Content>
            @*<SfTooltip ID="Tooltip" Target="#gidzanbtn" EnableRtl="true" IsSticky="true" Content="@GidZanToolContentContent"
                Position="Position.LeftCenter"></SfTooltip>*@

            <div class="row">
                <div class="col" style="text-align:right">
                    @*<input type="text" class="form-control" style="width:200px"
                        placeholder="הכנסת זן בלבד(לא חובה)"
                        @bind=@SearchByZan />*@
                    <br />
                    <button id="gidzanbtn" style="text-align:left" class="btn btn-outline-secondary" @onclick="@(_ => {GetKpassportsByGidulAndZan();})">טעינת כל המצאי</button>

                </div>
                <div class="col">

                </div>

            </div>
            <br />
            <SfTab HeaderPlacement="HeaderPosition.Top">
                <TabEvents Selecting="Select">
                </TabEvents>
                <TabItems>
                    <TabItem>
                        <ChildContent>
                            <TabHeader Text="בחירת מזרע"></TabHeader>
                        </ChildContent>
                        <ContentTemplate>
                            <div style="text-align:right" class="alert alert-info" role="alert">
                                <div class="row">
                                    <div class="col">
                                        <h5 style="text-align:right">לקוח: @K_OrderForPickPassport.CxName</h5>
                                        <h5 style="text-align:right">שתילים: @string.Format("{0:#,0}", K_OrderForPickPassport.JobPlantsNum)</h5>
                                        <h5 style="text-align:right">ממוצע: @K_OrderForPickPassport.JobPlansAvarage</h5>
                                    </div>
                                    <div class="col">
                                        <h5 style="text-align:right"> @DateTimeToShortString(K_OrderForPickPassport.MarketingDate),@KOrderAlgorithemShared.GetHebrewDayOfTheWeek(K_OrderForPickPassport.MarketingDate)</h5>
                                        <h5 style="text-align:right">מגשים: @K_OrderForPickPassport.JobNumOfMagash</h5>
                                    </div>
                                    <div class="col">
                                        <h5 style="text-align:right">גידול: @K_OrderForPickPassport.Gidul</h5>
                                        <h5 style="text-align:right">זן: @K_OrderForPickPassport.Zan</h5>
                                    </div>

                                    <div class="col">
                                        <h4 style="text-align:right">מגשים להוצאה: @K_OrderForPickPassport.JobNumOfMagash</h4>
                                        <h4 style="text-align:right">מגשים שנבחרו: @string.Format("{0:#,0}", KOrdersfunctions.GetTotalMagashPassportList(kOrderPassports))</h4>
                                        <hr />
                                        @{
                                            var magash = (KOrdersfunctions.GetTotalMagashPassportList(kOrderPassports) - K_OrderForPickPassport.JobNumOfMagash);
                                            if (magash < 0)
                                            {
                                                <h4 style="text-align:right;color:darkred">הפרש:   @string.Format("{0:#,0}", magash)</h4>
                                            }
                                            else
                                            {
                                                <h4 style="text-align:right;color:forestgreen">הפרש: @string.Format("{0:#,0}", magash)</h4>
                                            }
                                        }
                                    </div>
                                    <div class="col">
                                        <h4 style="text-align:right">שתילים להוצאה: @string.Format("{0:#,0}", K_OrderForPickPassport.JobPlantsNum)</h4>
                                        <h4 style="text-align:right">שתילים שנבחרו: @string.Format("{0:#,0}", KOrdersfunctions.GetTotalMagashPassportList(kOrderPassports, 1))</h4>
                                        <hr />
                                        @{
                                            var missingPlants = (KOrdersfunctions.GetTotalMagashPassportList(kOrderPassports, 1) - K_OrderForPickPassport.JobPlantsNum);
                                            if (missingPlants < 0)
                                            {
                                                <h4 style="text-align:right;color:darkred">הפרש:   @string.Format("{0:#,0}", missingPlants)</h4>

                                            }
                                            else
                                            {
                                                <h4 style="text-align:right;color:forestgreen">הפרש:   @string.Format("{0:#,0}", missingPlants)</h4>

                                            }}
                                    </div>
                                </div>
                            </div>
                            @*Spinner*@
                            <div class="col-sm">
                                <div class="spin-row">
                                    <SfSpinner Size="40" Label="" Type="SpinnerType.Bootstrap4" Visible="@LoadingSpinner" CssClass="e-customClass"></SfSpinner>
                                </div>
                            </div>

                            <div>

                                @{ if (K_OrderForPickPassport.K_OrderPassports != null && K_OrderForPickPassport.K_OrderPassports.Count() > 0)
                                    {
                                        <button class="btn btn-danger" @onclick="@(_ => {BtnSendKOrderPassportsToDB(4);})">מחיקה</button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-success" @onclick="@(_ => {BtnSendKOrderPassportsToDB(3);})">שליחה</button>
                                    }
                                }

                            </div>
                            <br />
                            <div class="row">
                                <div class="col">
                                    <table class="table table-striped table-hover table-responsive" style="text-align:right;width:auto">
                                        <thead>
                                            <tr>
                                                <th style="font-size:25px;font-weight:bold">
                                                    פספורט
                                                </th>
                                                <th style="font-size:25px;font-weight:bold">
                                                    מגשים
                                                </th>
                                                <th style="font-size:25px;font-weight:bold">
                                                    ממוצע
                                                </th>
                                                <th style="font-size:25px;font-weight:bold">
                                                    שתילים
                                                </th>
                                                <th style="font-size:25px;font-weight:bold">
                                                    עריכת מגשים
                                                </th>


                                            </tr>
                                        </thead>
                                        <tbody>
                                            @{ foreach (var passport in kOrderPassports)
                                                {
                                                    <tr>
                                                        <td style="font-size:25px;font-weight:bold">
                                                            @passport.K_PassportNum
                                                        </td>
                                                        <td style="font-size:25px;font-weight:bold">
                                                            @passport.PassportMagashAmpunt
                                                        </td>
                                                        <td style="font-size:25px;font-weight:bold">
                                                            @passport.SelectedAVG
                                                        </td>
                                                        <td style="font-size:25px;font-weight:bold">
                                                            @string.Format("{0:#,0}", passport.Platns)
                                                        </td>
                                                        <td style="font-size:25px;">
                                                            <input type="number" @bind-value=@passport.MagashToCompare style="width:100px" placeholder="@passport.PassportMagashAmpunt" />
                                                        </td>
                                                        @{if (K_OrderForPickPassport.K_OrderPassports.Contains(passport))
                                                            {
                                                                <td>
                                                                    <button class="btn btn-primary" @onclick="@(_ => { UpdateKorderPassport(passport); })">עריכה</button>
                                                                </td>
                                                                <td>
                                                                    <button class="btn btn-danger" @onclick="@(_ => { DeleteKorderPassport(passport); })">מחיקה</button>
                                                                </td>

                                                            }
                                                            else if (!K_OrderForPickPassport.K_OrderPassports.Contains(passport) && K_OrderForPickPassport.K_OrderPassports.Count() > 0)
                                                            {
                                                                <td>
                                                                    <button class="btn btn-success" @onclick="@(_ => { SendKorderPassport(passport); })">שליחה</button>
                                                                </td>
                                                            }
                                                        }

                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col">

                                </div>
                            </div>


                            @*GRID SECTION START HERE*@
                            <SfGrid DataSource="@k_PassportsForKorder" FrozenRows="0" Height="500" Width="100%" AllowPaging="true" @ref="@SfGridKpassport" Toolbar=@Tool AllowGrouping="false" AllowFiltering="true"
                                    AllowSorting="true" EnableRtl="true" AllowResizing="true">
                                <GridEvents QueryCellInfo="CustomizeCell" CommandClicked="OnCommandClickedPickPassports" RowDataBound="PickPassportsRowBound"
                                            TValue="K_Passport"></GridEvents>
                                <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel"></GridFilterSettings>
                                <GridPageSettings PageSize="40"></GridPageSettings>
                                <GridTemplates>

                                    <DetailTemplate>

                                        <div style="text-align:right;width:auto">
                                            <SfTab HeaderPlacement="HeaderPosition.Top">
                                                <TabItems>
                                                    <TabItem>
                                                        <ChildContent>
                                                            <TabHeader Text="לקוחות"></TabHeader>
                                                        </ChildContent>
                                                        <ContentTemplate>
                                                            @{ var passport = (context as K_Passport);
                                                                <table class="table table-striped table-hover" style="text-align:right;width:auto">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>
                                                                                לקוח
                                                                            </th>
                                                                            <th>
                                                                                הזמנה
                                                                            </th>
                                                                            <th>
                                                                                מגשים
                                                                            </th>
                                                                            <th>
                                                                                ת.הוצאה
                                                                            </th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>

                                                                        @foreach (var cx in passport.Passport.Passprods.OrderByDescending(x => x.UQuantity))
                                                                        {
                                                                            decimal? temp;
                                                                            int startAvg;
                                                                            if (passport.Passport.UQuanOrdP > 5555554)
                                                                            {
                                                                                temp = passport.Passport.UQuanProd * 1000;
                                                                                startAvg = Convert.ToInt32((passport.Passport.UQuanProd * 1000) / passport.Passport.UTraySow);
                                                                            }
                                                                            else
                                                                            {
                                                                                temp = (cx.UQuantity * 1000);
                                                                                startAvg = Convert.ToInt32((passport.Passport.UQuanOrdP * 1000) / passport.Passport.UTraySow);
                                                                            }

                                                                            var display = string.Format("{0:#,0}", temp);
                                                                            var magashPercx = temp / startAvg;
                                                                            var magashPercxScreen = string.Format("{0:#,0}", magashPercx);
                                                                            <tr>
                                                                                <td>
                                                                                    @cx.UCustName
                                                                                </td>
                                                                                <td>
                                                                                    @display
                                                                                </td>
                                                                                <td>
                                                                                    @magashPercxScreen
                                                                                </td>
                                                                                <td>
                                                                                    @Convert.ToDateTime(cx.UDateSupp).ToShortDateString()
                                                                                </td>
                                                                            </tr>
                                                                        }
                                                                    </tbody>
                                                                </table>
                                                            }
                                                        </ContentTemplate>
                                                    </TabItem>
                                                    <TabItem>
                                                        <ChildContent>
                                                            <TabHeader Text="הערות"></TabHeader>
                                                        </ChildContent>
                                                        <ContentTemplate>
                                                            @{ var passport1 = (context as K_Passport);
                                                                <table class="table table-striped table-hover" style="text-align:right;width:auto">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>
                                                                                תאריך
                                                                            </th>
                                                                            <th>
                                                                                נוספה ע"י
                                                                            </th>
                                                                            <th>
                                                                                מצב
                                                                            </th>
                                                                            <th>
                                                                                תיאור
                                                                            </th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>

                                                                        @foreach (var form in passport1.PassportAuditForms.OrderByDescending(x => x.CreateDate))
                                                                        {

                                                                            <tr>
                                                                                <td>
                                                                                    @form.CreateDate
                                                                                </td>
                                                                                <td>
                                                                                    @form.UserName
                                                                                </td>
                                                                                <td>
                                                                                    @form.AuditStatus
                                                                                </td>
                                                                                <td>
                                                                                    @form.Remark
                                                                                </td>
                                                                            </tr>

                                                                        }
                                                                    </tbody>
                                                                </table>
                                                            }
                                                        </ContentTemplate>
                                                    </TabItem>
                                                    <TabItem>
                                                        <ChildContent>
                                                            <TabHeader Text="היסטוריית עריכה"></TabHeader>
                                                        </ChildContent>
                                                        <ContentTemplate>
                                                            @{ var passport2 = (context as K_Passport);
                                                                <table class="table table-striped table-hover" style="text-align:right;width:auto">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>
                                                                                תאריך
                                                                            </th>
                                                                            <th>
                                                                                נערכה ע"י
                                                                            </th>
                                                                            <th>
                                                                                תיאור
                                                                            </th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        @foreach (var updateAudit in passport2.k_PassportAuditTblVer2s.OrderByDescending(x => x.Date))
                                                                        {

                                                                            <tr>
                                                                                <td>
                                                                                    @updateAudit.Date
                                                                                </td>
                                                                                <td>
                                                                                    @updateAudit.UserName
                                                                                </td>
                                                                                <td>
                                                                                    @updateAudit.AuditString
                                                                                </td>
                                                                            </tr>
                                                                        }
                                                                    </tbody>
                                                                </table>
                                                            }
                                                        </ContentTemplate>
                                                    </TabItem>
                                                    <TabItem>
                                                        <ChildContent>
                                                            <TabHeader Text="נתונים נוספים"></TabHeader>
                                                        </ChildContent>
                                                        <ContentTemplate>
                                                            @{ var passport2 = (context as K_Passport);
                                                                <div class="form-row" dir="rtl">
                                                                    <div class="col-form-label">
                                                                        @{ if (passport2.GrowingRoom == null)
                                                                            {
                                                                                <label class="form-check-label" style="text-align: right; font-weight:500">הוכנס ישירות למצאי ע"י</label>
                                                                            }
                                                                            else
                                                                            { <label class="form-check-label" style="text-align: right; font-weight:500">הוכנס לחדר הנבטה ע"י:</label>
                                                                            }
                                                                        }
                                                                    </div>
                                                                    <div class="col-form-label">
                                                                        <label class="form-check-label" style="text-align:right;">@passport2.KPassportInsertAudit.UserName</label>
                                                                    </div>
                                                                    <div class="col-form-label">
                                                                        <label class="form-check-label" style="text-align:right;">@passport2.KPassportInsertAudit.Date</label>
                                                                    </div>
                                                                </div>
                                                                <div class="form-row" dir="rtl">
                                                                    <div class="col-form-label">
                                                                        <label class="form-check-label" style="text-align: right; font-weight:500">מקדם זריעה SAP:</label>
                                                                    </div>
                                                                    <div class="col-form-label">
                                                                        <label class="form-check-label" style="text-align:right">@passport2.PassportStartingAVG</label>
                                                                    </div>
                                                                </div>
                                                            }
                                                        </ContentTemplate>
                                                    </TabItem>
                                                </TabItems>
                                            </SfTab>
                                        </div>
                                    </DetailTemplate>

                                </GridTemplates>

                                <GridAggregates>
                                    <GridAggregate>
                                        <GridAggregateColumns>
                                            <GridAggregateColumn Field=@nameof(K_Passport.PassportNum) Type="AggregateType.Count">
                                                <FooterTemplate>
                                                    @{
                                                        var aggregate = (context as AggregateTemplateContext);


                                                        var num = Convert.ToInt32(aggregate.Count);
                                                        var magashNum = string.Format("{0:#,0}", num);
                                                        <b>ספירה:@magashNum</b>

                                                    }
                                                </FooterTemplate>
                                            </GridAggregateColumn>
                                            <GridAggregateColumn Field=@nameof(K_Passport.MagashAmount) Type="AggregateType.Sum">
                                                <FooterTemplate>
                                                    @{
                                                        var aggregate = (context as AggregateTemplateContext);
                                                        var num = Convert.ToInt32(aggregate.Sum);
                                                        var magashNum = string.Format("{0:#,0}", num);
                                                        <b>@magashNum</b>
                                                    }
                                                </FooterTemplate>
                                            </GridAggregateColumn>
                                        </GridAggregateColumns>
                                    </GridAggregate>

                                </GridAggregates>

                                <GridColumns>
                                    <GridColumn Field=@nameof(K_Passport.K_PassportId) HeaderText="" HeaderTextAlign="TextAlign.Center" Type="ColumnType.Number" IsPrimaryKey="true" Visible="false" TextAlign="TextAlign.Center"></GridColumn>
                                    <GridColumn Field=@nameof(K_Passport.Hamama) HeaderText="חמ'" HeaderTextAlign="TextAlign.Center" Type="ColumnType.Number" Format="N0" TextAlign="TextAlign.Center"></GridColumn>
                                    <GridColumn Field=@nameof(K_Passport.Gamlon) HeaderText="גמ'" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center"></GridColumn>
                                    <GridColumn Field=@nameof(K_Passport.PassportNum) HeaderText="פספורט" FilterSettings="@(new FilterSettings{Operator = Syncfusion.Blazor.Operator.Contains})" AllowEditing="false" HeaderTextAlign="TextAlign.Center" Type="ColumnType.Number" TextAlign="TextAlign.Center"></GridColumn>
                                    <GridColumn Field=@nameof(K_Passport.Gidul) HeaderText="גידול" FilterSettings="@(new FilterSettings{Operator = Syncfusion.Blazor.Operator.Contains})" AllowEditing="false" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center"></GridColumn>
                                    <GridColumn Field=@nameof(K_Passport.Zan) HeaderText="זן" AllowEditing="false" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center"> </GridColumn>
                                    <GridColumn Field=@nameof(K_Passport.DateEnd) HeaderText="ת.הוצאה" AllowEditing="false" HeaderTextAlign="TextAlign.Center" Format="d" Type="ColumnType.Date" TextAlign="TextAlign.Center"></GridColumn>
                                    <GridColumn Field=@nameof(K_Passport.PassportAge) HeaderText="גיל" AllowEditing="false" HeaderTextAlign="TextAlign.Center" Type="ColumnType.Number" TextAlign="TextAlign.Center"></GridColumn>
                                    <GridColumn Field=@nameof(K_Passport.MagashAmount) HeaderText="מגשים" HeaderTextAlign="TextAlign.Center" Type="ColumnType.Number" Format="N0" TextAlign="TextAlign.Center"></GridColumn>
                                    <GridColumn Field="@nameof(K_Passport.PassportAVG)" HeaderText="ממוצע" AllowEditing="false" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center">
                                        <Template>
                                            @{
                                                var value = (context as K_Passport);
                                                var AVG = value.PassportAVG == -1 ? "ללא" : Convert.ToString(value.PassportAVG);
                                                <b>@AVG</b>
                                            }
                                        </Template>
                                    </GridColumn>
                                    <GridColumn Field=@nameof(K_Passport.PassportCondition) HeaderText="מצב" AllowEditing="false" HeaderTextAlign="TextAlign.Center" Type="ColumnType.String" TextAlign="TextAlign.Center"></GridColumn>
                                    <GridColumn Field=@nameof(K_Passport.CelsTray) HeaderText="סוג מגש" AllowEditing="false" HeaderTextAlign="TextAlign.Center" Format="N0" Type="ColumnType.Number" TextAlign="TextAlign.Center"></GridColumn>
                                    <GridColumn HeaderText="בחירה" HeaderTextAlign="TextAlign.Center" TextAlign="TextAlign.Center">
                                        <GridCommandColumns>
                                            <GridCommandColumn Type=CommandButtonType.None
                                                               ButtonOption="@(new CommandButtonOptions() {  IconCss ="e-icons e-plus-icon", CssClass = "e-round", IsPrimary = true })">
                                            </GridCommandColumn>
                                        </GridCommandColumns>
                                    </GridColumn>
                                </GridColumns>

                            </SfGrid>
                        </ContentTemplate>
                    </TabItem>
                    <TabItem>
                        <ChildContent>
                            <TabHeader Text=""></TabHeader>
                        </ChildContent>
                        <ContentTemplate>

                        </ContentTemplate>
                    </TabItem>
                </TabItems>
            </SfTab>


        </Content>

        <FooterTemplate>

        </FooterTemplate>
    </DialogTemplates>
</SfDialog>


@*Confirm Action Dialog *@
<SfDialog Target="#target" EnableRtl="true"
          Width="280px"
          Height="175px"
          IsModal="true"
          ShowCloseIcon="false"
          @bind-Visible="@DialogVisability">
    <DialogTemplates>
        <Header>@ActionDialogHeader</Header>
        <Content>
            @ActionDialogText
        </Content>
        <FooterTemplate>
            <div class="button-container">
                <button type="submit"
                        class="btn btn-success"
                        @onclick="@(_ => { ConfirmCutYes(); })">
                    אישור
                </button>
                <button type="submit" style="margin-right:25px"
                        class="btn btn-danger"
                        @onclick="@(_ => { ConfirmDestroyNo(); })">
                    ביטול
                </button>
            </div>
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>

@code {

    //Adding List of jobs to cx
    #region Adding List of jobs to cx

    List<K_Order> k_OrdersCxManyJobs { get; set; } = new List<K_Order>();
    K_Order K_OrderCxManyJobs { get; set; }

    K_Passport k_Passport = new K_Passport
    {
        UserName = "boontan",
        PassportNum = 73122,


    };
    #endregion

    //KOrder Cnacel Dialog
    #region KOrder Cnacel Dialog
    public bool CancelKorderShow { get; set; } = false;
    public bool IsListOfCancelJobs { get; set; } = false;
    //T.box and Who canceled
    string TboxCancel, WhoCancel;

    //KOrder Job Status list
    List<string> KorderCancelWhoCancelList = K_OrderStatus.GetWhoCancelKorderList();

    void KorderCancelHide()
    {
        CancelKorderShow = false;
        IsListOfCancelJobs = false;
    }

    void KorderCancelShow()
    {
        CancelKorderShow = true;
    }
    //set wasedit after passports attached to FALSE
    async void KorderConfirmEdit()
    {
        RowEditDialogShow = false;
        LoadingSpinner = true;
        await UpdateJobConfirmEdit();
        LoadingSpinner = false;
        StateHasChanged();
        if (IsConnected) await SendMessage();
        ToastContent = "נשמר!";
        await ShowToast();
    }
    async Task<int> UpdateJobConfirmEdit()
    {
        K_OrderForEdit.WasEditAfterAttachedPassports = false;
        var StandByrslt = await Http.PutAsJsonAsync($"api/WeeklyKOrder/UpdateTodayTomorrowOrder/{K_OrderForEdit.JobId}", K_OrderForEdit);
        if (!StandByrslt.IsSuccessStatusCode)
        {

            ErrorModalHeaderContent = "שגיאה!";
            ModalError = StandByrslt.ReasonPhrase; ;
            ErrorDialogIsVisible = true;
            LoadingSpinner = false;
            return 1;
        }
        return 0;
    }
    async void SendOrderCancelForm()
    {
        if (String.IsNullOrEmpty(TboxCancel) || String.IsNullOrEmpty(WhoCancel))
        {
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "יש למלא את שתי האופציות!";
            ErrorDialogIsVisible = true;
            return;
        }

        KorderCancelHide();
        RowEditDialogShow = false;
        LoadingSpinner = true;
        await SendJobCancelForm();
        ToastContent = "נשמר!";
        LoadingSpinner = false;
        await ShowToast();
        //StateHasChanged();
        if (IsConnected) await SendMessage();
        WhoCancel = "";
        TboxCancel = "";


    }
    async Task<int> SendJobCancelForm()
    {
        try
        {

            K_OrderRemark.JobId = K_OrderForEdit.JobId;
            K_OrderRemark.Remark = $"ביטול עבודה-מי ביטל: {WhoCancel} סיבת ביטול:{TboxCancel}";
            if (K_OrderForEdit.IsDeliveryNote == true) { K_OrderForEdit.IsWasChangedAfterDeliveryReport = true; }

            if (K_OrderForEdit.K_OrderPassports.Count() > 0)
            {
                K_OrderForEdit.IsPrinted = false;
            }
            else
            {
                K_OrderForEdit.JobStatus = K_OrderPhase.Canceled;
            }
            K_OrderForEdit.IsJobCancel = true;
            await Http.PostAsJsonAsync(("api/WeeklyKOrder/NewKOrderRemark"), K_OrderRemark);
            await Http.PutAsJsonAsync($"api/WeeklyKOrder/UpdateTodayTomorrowOrder/{K_OrderForEdit.JobId}", K_OrderForEdit);
            K_OrderRemark = new K_OrderRemark();

        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
            return 1;
        }
        return 0;
    }
    #endregion

    //KOrder Remark
    #region KOrder Remark

    // Property to control the row edit dialog.
    public bool KOrderRemarkShow { get; set; } = false;

    K_OrderRemark K_OrderRemark { get; set; } = new K_OrderRemark();

    void ShowKorderRemark()
    {
        KOrderRemarkShow = true;
    }
    void KOrderRemarkHide()
    {
        KOrderRemarkShow = false;
    }
    async void SetJobIsCancelFalse()
    {
        RowEditDialogShow = false;
        LoadingSpinner = true;
        K_OrderForEdit.IsJobCancel = false;
        if (K_OrderForEdit.JobStatus == K_OrderPhase.Canceled) { K_OrderForEdit.JobStatus = K_OrderPhase.StandBy; }
        if (K_OrderForEdit.JobStatus == K_OrderPhase.InProgress) { K_OrderForEdit.IsPrinted = true; }
        var StandByrslt = await Http.PutAsJsonAsync($"api/WeeklyKOrder/UpdateTodayTomorrowOrder/{K_OrderForEdit.JobId}", K_OrderForEdit);
        if (!StandByrslt.IsSuccessStatusCode)
        {

            ErrorModalHeaderContent = "שגיאה!";
            ModalError = StandByrslt.ReasonPhrase; ;
            ErrorDialogIsVisible = true;
            LoadingSpinner = false;
            return;
        }

        if (IsConnected) await SendMessage();
        ToastContent = "נשמר!";
        StateHasChanged();
        LoadingSpinner = false;
        await ShowToast();


    }

    async void DeletePassAndCancelJob(int action = 0)
    {
        RowEditDialogShow = false;
        LoadingSpinner = true;
        K_OrderForEdit.JobStatus = K_OrderPhase.Canceled;
        await SendKOrderPassportsToDB(4);
        K_OrderForEdit.IsPrinted = false;
        var StandByrslt = await Http.PutAsJsonAsync($"api/WeeklyKOrder/UpdateTodayTomorrowOrder/{K_OrderForEdit.JobId}", K_OrderForEdit);
        if (!StandByrslt.IsSuccessStatusCode)
        {
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = StandByrslt.ReasonPhrase; ;
            ErrorDialogIsVisible = true;
            LoadingSpinner = false;
            return;
        }


        ToastContent = "נשמר!";
        //StateHasChanged();
        LoadingSpinner = false;
        await ShowToast();
        if (IsConnected) await SendMessage();

    }

    async void SendOrderRemark()
    {
        if (String.IsNullOrEmpty(K_OrderRemark.Remark))
        {
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "לא נרשמה הערה!";
            ErrorDialogIsVisible = true;
            return;
        }
        KOrderRemarkShow = false;
        RowEditDialogShow = false;
        LoadingSpinner = true;
        await SendRemarkToDb();
        K_OrderRemark = new K_OrderRemark();
        if (IsConnected) await SendMessage();
        ToastContent = "נשמר!";
        StateHasChanged();
        LoadingSpinner = false;
        await ShowToast();

    }
    async Task<int> SendRemarkToDb()
    {
        try
        {
            K_OrderRemark.JobId = K_OrderForEdit.JobId;
            await Http.PostAsJsonAsync(("api/WeeklyKOrder/NewKOrderRemark"), K_OrderRemark);
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
            return 1;
        }
        return 0;
    }
    #endregion

    //KOrder RETURN JOB
    #region KOrder RETURN JOB
    // Property to control the row edit dialog.
    public bool KOrderReturnShow { get; set; } = false;
    string WhyKOrderWasReturn;
    void SendOrderReturn()
    {
        if (String.IsNullOrEmpty(WhyKOrderWasReturn))
        {
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "לא נרשמה סיבת החזרה!";
            ErrorDialogIsVisible = true;
            return;
        }
        if (K_OrderForEdit.JobNumOfMagash <= 0)
        {
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "כמות מגשים לא תקינה!";
            ErrorDialogIsVisible = true;
            return;
        }

    }
    void ShowKorderReturn()
    {
        WhyKOrderWasReturn = "";
        KOrderReturnShow = true;
    }
    void KOrderReturnHide()
    {
        KOrderReturnShow = false;
    }
    #endregion

    //Drivers
    #region DRIVERS
    List<Driver> Drivers { get; set; } = new List<Driver>();
    Driver Driver { get; set; } = new Driver();
    DriversToOrder _driver { get; set; } = new DriversToOrder();
    string DriverId;

    async void SendDriverToOrder()
    {
        if (selectedRows.Count() == 0)
        {
            ErrorDialogIsVisible = true;
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "לא נבחרו עבודות!";
        }

        else
        {
            Driver = Drivers.Where(x => x.DriverId == DriverId).FirstOrDefault();
            _driver.DriverId = Driver.DriverId;
            _driver.UserName = Driver.UserName;
            _driver.PhoneNumber = Driver.PhoneNumber;
            _driver.ScreenName = Driver.ScreenName;


            LoadingSpinner = true;
            await SendDriverToOrderToDB();
            ToastContent = "נשמר!";

            LoadingSpinner = false;
            await ShowToast();
            //StateHasChanged();
            if (IsConnected) await SendMessage();
        }
    }
    async Task<int> SendDriverToOrderToDB()
    {

        foreach (var row in selectedRows)
        {
            _driver.JobId = row.JobId;

            if (row.DriversToOrders.Count == 0)
            {
                await Http.PostAsJsonAsync("api/Drivers/Drivers/PostDriver", _driver);
            }
            else if (row.DriversToOrders.Count == 1)
            {
                await Http.PutAsJsonAsync<DriversToOrder>("api/Drivers/Drivers/PostDriver", _driver);
            }
            else if (row.DriversToOrders.Count > 1)
            {
                continue;
            }
        }
        return 0;
    }
    #endregion

    //Page settings
    #region Page Settings

    //list of KOrder(Grid Rows)
    K_Order[] K_Orders;

    //"מחפש בין התאריכים Show Counter"
    bool ShowCorrectDate = false;

    //For short date string
    string startDate, endDate;

    // Hub
    private HubConnection hubConnection;
    public bool IsConnected =>
    hubConnection.State == HubConnectionState.Connected;

    Task SendMessage() => hubConnection.SendAsync("SendMessage");
    Task SendMessageForPickPassport() => hubConnection.SendAsync("SendMessageForPickPassport");


    //getting week sun to sat dates
    string ReportBeginDate = KOrderAlgorithemShared.GetPrepReportWeekRange(DateTime.Today)[0].ToShortDateString();
    string ReportEndDate = KOrderAlgorithemShared.GetPrepReportWeekRange(DateTime.Today)[1].ToShortDateString();

    //Loading Spinner
    bool LoadingSpinner { get; set; } = false;

    public void Select(SelectingEventArgs args)
    {
        if (args.IsSwiped)
        {
            args.Cancel = true;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadDataOrder();
        hubConnection = new HubConnectionBuilder()
           .WithUrl(NavigationManager.ToAbsoluteUri("/broadcastHub"))
           .Build();

        hubConnection.On("ReceiveMessage", () =>
        {

            Task.Run(async () => { await LoadDataOrder(); });
            StateHasChanged();
        });
        hubConnection.On("PickPassport", () =>
        {

            Task.Run(async () => { await LoadPickPassportData(); });
            StateHasChanged();
        });
        //call loadData every 5 min
        await hubConnection.StartAsync();
        var timer = new System.Timers.Timer();
        timer.Interval = 300000;
        timer.Elapsed += new ElapsedEventHandler(OnTimedEvent);
        timer.AutoReset = true;
        timer.Enabled = true;

    }
    private async void OnTimedEvent(Object source, ElapsedEventArgs e)
    {
        await LoadDataOrder();
    }
    async Task LoadPickPassportData()
    {
        try
        {
            return;
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
        }
    }
    //Get list Of KOrder Todat/Tomorrow Objects
    protected async Task LoadDataOrder()
    {
        try
        {
            ShowCorrectDate = false;
            K_Orders = await Http.GetFromJsonAsync<K_Order[]>("api/WeeklyKOrder/GetKOrdersForTodayTomorrow");
            //For Greed No.1
            GridNo1List = K_Orders.Where(x => (x.IsTakeoutJobTomorrow == false && x.IsNeedToConfirmJob == false)
            || (x.IsTakeoutJobTomorrow == null && x.IsNeedToConfirmJob == null)).ToList();
            //GET CX FROM SAP
            DropDownKOrderSapCxNames = await Http.GetFromJsonAsync<List<string>>("api/WeeklyKOrder/GetSapCxListAsString");
            //GET PASSPORTS
            k_PassportsForJobs = await Http.GetFromJsonAsync<K_Passport[]>("api/KPassports/ForKOrderJobs");

            //For GRID No. 2
            NeedToConfirmRecords = K_Orders.Where(x => x.IsNeedToConfirmJob == true || x.IsTakeoutJobTomorrow == true).ToList();

            Giduls = k_PassportsForJobs.Select(x => x.Gidul).Distinct().ToList();
            Zans = k_PassportsForJobs.Select(x => x.Zan).Distinct().ToList();

            //GET Drivers
            Drivers = await Http.GetFromJsonAsync<List<Driver>>("api/Drivers/Drivers/GetListOfDrivers");

            StateHasChanged();
        }
        catch (Exception e) { Console.WriteLine(e.Message); }
    }
    #endregion

    //New Job Form
    #region New Job Form

    //AVG string for Auto calc num of magash
    string AVGAutoCalc = "";
    int temoavg = 0;

    //for Auto plants Calc
    string AutoPlantsCalc, AutoMagashCalc;

    //Marketing Date Auto set on Today+1
    public DateTime? DateValue { get; set; } = DateTime.Today.AddDays(1);

    private bool NewJobFormIsVisible { get; set; } = false;

    //object for insert new job
    K_Order NewJobK_Order { get; set; } = new K_Order();

    //list of korder only for dropdown sap cx list
    //K_Order[] DropDownKOrderSapCxNames;
    List<string> DropDownKOrderSapCxNames;
    //Passports for gidul and zan
    K_Passport[] k_PassportsForJobs;

    List<string> Giduls = new List<string>();
    List<string> Zans = new List<string>();

    void BtnAddAnotherJobToCx()
    {
        K_OrderCxManyJobs = new K_Order();
        K_OrderCxManyJobs = NewJobK_Order;
        k_OrdersCxManyJobs.Add(K_OrderCxManyJobs);
        NewJobK_Order = new K_Order();
        NewJobK_Order.MarketingDate = K_OrderCxManyJobs.MarketingDate;
        NewJobK_Order.CxName = K_OrderCxManyJobs.CxName;
        NewJobK_Order.CardCode = K_OrderCxManyJobs.CardCode;
        K_OrderCxManyJobs = new K_Order();
    }
    //new job after button click
    async void BtnSendNewJob(K_Order k_Order)
    {
        //if no cx and or market date null
        if (String.IsNullOrWhiteSpace(k_Order.CxName))
        {
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "לקוח נדרש!";
            ErrorDialogIsVisible = true;
            return;
        }

        //id market date for the past dates
        var md = Convert.ToDateTime(DateValue).Subtract(DateTime.Today).TotalDays;
        if (md < 0)
        {
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "תאריך הוצאה חייב להיות עתידי!";
            ErrorDialogIsVisible = true;
            return;
        }
        if (md > 14)
        {
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "ניתן להכניס עבודה עד שבועיים מראש!";
            ErrorDialogIsVisible = true;
            return;
        }

        NewJobFormIsVisible = false;
        LoadingSpinner = true;
        if (k_OrdersCxManyJobs.Count() > 0)
        {
            k_OrdersCxManyJobs.Add(NewJobK_Order);
            await SendNewJobList(k_OrdersCxManyJobs);
        }
        else
        {
            await SendNewJob(k_Order);
        }
        LoadingSpinner = false;
    }

    //New KOrder job List!
    public async Task<int> SendNewJobList(List<K_Order> k_Orderlist)
    {
        foreach (var k_Order in k_Orderlist)
        {
            try
            {
                k_Order.KOrderEnteringDate = DateTime.Today;
                k_Order.MarketingDate = DateValue;
                k_Order.JobStatus = K_OrderPhase.StandBy;

                if (!String.IsNullOrEmpty(k_Order.Gidul) && !String.IsNullOrEmpty(k_Order.Zan))
                {
                    try
                    {
                        k_Order.ItemCode = k_PassportsForJobs.Where(x => x.Gidul == k_Order.Gidul && x.Zan == k_Order.Zan).Select(x => x.ItemCode).Distinct().FirstOrDefault();
                    }
                    catch (Exception e)
                    {
                        Console.WriteLine(e.Message);
                        ErrorDialogIsVisible = true;
                        ErrorModalHeaderContent = "שגיאה!";
                        ModalError = "גידול וזן לא קיימים!";
                        return 1;
                    }
                    if (String.IsNullOrEmpty(k_Order.ItemCode))
                    {
                        ErrorModalHeaderContent = "שגיאה!";
                        ModalError = "גידול וזן לא קיימים!";
                        return 1;
                    }
                }

                if (k_Order.CxName.Contains("כלובים קטנים"))
                {
                    k_Order.IsCageSmall = true;
                }
                var rslt = await Http.PostAsJsonAsync("api/WeeklyKOrder/NewKOrderInsert", k_Order);
                var content = await rslt.Content.ReadAsStringAsync();

                //Http Response Failed On Insert
                if (rslt.IsSuccessStatusCode)
                {
                    continue;
                }
            }
            catch (Exception e)
            {
                Console.WriteLine(e.Message);
                return 1;
            }
        }

        if (IsConnected) await SendMessage();
        ToastContent = "נשמר!";
        StateHasChanged();
        await ShowToast();
        NewJobK_Order = new K_Order();
        AVGAutoCalc = "";
        k_OrdersCxManyJobs.Clear();

        return 0;
    }

    //New KOrder job
    public async Task<int> SendNewJob(K_Order k_Order)
    {
        try
        {
            k_Order.KOrderEnteringDate = DateTime.Today;
            k_Order.MarketingDate = DateValue;
            k_Order.JobStatus = K_OrderPhase.StandBy;

            if (!String.IsNullOrEmpty(k_Order.Gidul) && !String.IsNullOrEmpty(k_Order.Zan))
            {
                try
                {
                    k_Order.ItemCode = k_PassportsForJobs.Where(x => x.Gidul == k_Order.Gidul && x.Zan == k_Order.Zan).Select(x => x.ItemCode).Distinct().FirstOrDefault();
                }
                catch (Exception e)
                {
                    Console.WriteLine(e.Message);
                    ErrorDialogIsVisible = true;
                    ErrorModalHeaderContent = "שגיאה!";
                    ModalError = "גידול וזן לא קיימים!";
                    return 1;
                }
                if (String.IsNullOrEmpty(k_Order.ItemCode))
                {
                    ErrorModalHeaderContent = "שגיאה!";
                    ModalError = "גידול וזן לא קיימים!";
                    return 1;
                }
            }

            if (k_Order.CxName.Contains("כלובים קטנים"))
            {
                k_Order.IsCageSmall = true;
            }
            var rslt = await Http.PostAsJsonAsync("api/WeeklyKOrder/NewKOrderInsert", k_Order);
            var content = await rslt.Content.ReadAsStringAsync();

            //Http Response Failed On Insert
            if (rslt.IsSuccessStatusCode)
            {
                if (IsConnected) await SendMessage();
                ToastContent = "נשמר!";
                StateHasChanged();
                await ShowToast();
            }
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
            return 1;
        }

        NewJobK_Order = new K_Order();
        DateValue = DateTime.Today.AddDays(1);
        AVGAutoCalc = "";
        return 0;
    }

    //Giduz & Zan inputs
    void GidulMouseClick(Microsoft.AspNetCore.Components.Web.MouseEventArgs mouseEventArgs)
    {
        if (mouseEventArgs.Buttons == 1)
        {
            if (NewJobK_Order.Zan != null)
            {
                try
                {
                    NewJobK_Order.Gidul = k_PassportsForJobs.Where(x => x.Zan == NewJobK_Order.Zan).Select(x => x.Gidul).Distinct().Single();

                }
                catch (Exception e)
                {
                    Console.WriteLine(e.Message);
                    Giduls = k_PassportsForJobs.Select(x => x.Gidul).Distinct().ToList();
                }
            }
        }
    }
    void CheckGidulForEdit(Microsoft.AspNetCore.Components.Web.MouseEventArgs mouseEventArgs)
    {
        if (mouseEventArgs.Buttons == 0 && String.IsNullOrEmpty(K_OrderForEdit.Gidul))
        {
            var zan = K_OrderForEdit.Zan;
            try
            {
                var gidul = k_PassportsForJobs.Where(x => x.Zan == zan).Select(x => x.Gidul).FirstOrDefault();
                if (!String.IsNullOrEmpty(gidul))
                {
                    K_OrderForEdit.Gidul = gidul;
                    StateHasChanged();
                }

            }
            catch (Exception e)
            {
                Console.WriteLine(e.Message);
            }
        }
    }

    //check if zan fill and gidul =null the auto fill gidul when zan finished
    void CheckGidul(Microsoft.AspNetCore.Components.Web.MouseEventArgs mouseEventArgs)
    {
        if (mouseEventArgs.Buttons == 0 && String.IsNullOrEmpty(NewJobK_Order.Gidul))
        {
            var zan = NewJobK_Order.Zan;
            try
            {
                var gidul = k_PassportsForJobs.Where(x => x.Zan == zan).Select(x => x.Gidul).FirstOrDefault();
                if (!String.IsNullOrEmpty(gidul))
                {
                    NewJobK_Order.Gidul = gidul;
                    StateHasChanged();
                }

            }
            catch (Exception e)
            {
                Console.WriteLine(e.Message);
            }
        }

    }
    //After Pick Zan MouseClick
    void ZanMouseClick(Microsoft.AspNetCore.Components.Web.MouseEventArgs mouseEventArgs)
    {
        if (mouseEventArgs.Buttons == 1)
        {
            try
            {
                if (!String.IsNullOrEmpty(NewJobK_Order.Gidul))
                {
                    Zans = k_PassportsForJobs.Where(x => x.Gidul == NewJobK_Order.Gidul).Select(x => x.Zan).Distinct().ToList();
                }
                else
                {
                    NewJobK_Order.Gidul = k_PassportsForJobs.Where(x => x.Zan == NewJobK_Order.Zan).Select(x => x.Gidul).Distinct().Single();
                    Zans = k_PassportsForJobs.Select(x => x.Zan).Distinct().ToList();
                }
            }
            catch (Exception e)
            {
                Console.WriteLine(e.Message);

            }
        }
    }


    //AVG Input
    void KeyDown(KeyboardEventArgs args)
    {
        try
        {
            var numList = new List<string>
{
                "0","1","2","3","4","5","6","7","8","9"
            };
            if (numList.Contains(args.Key))
            {
                AVGAutoCalc += args.Key;
                var intAvg = Convert.ToInt32(AVGAutoCalc);
                var magash = NewJobK_Order.JobPlantsNum / intAvg;
                NewJobK_Order.JobNumOfMagash = magash;
                AutoPlantsCalc = NewJobK_Order.JobPlantsNum.ToString();
                AutoMagashCalc = magash.ToString();
            }
            if (args.Code == "Backspace")
            {
                AVGAutoCalc = AVGAutoCalc.Remove(AVGAutoCalc.Length - 1, 1);
            }
            if (args.Code == "Delete")
            {
                AVGAutoCalc = "";
            }

        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
        }

    }



    //open new job form btn click
    void BtnOpenNewJobForm()
    {
        AutoPlantsCalc = "";
        NewJobFormIsVisible = true;
    }
    //close new job form
    void NewJobCloseForm()
    {
        NewJobFormIsVisible = false;
        NewJobK_Order = new K_Order();
        AVGAutoCalc = "";
    }

    #endregion

    //Error/Alert Modal
    #region Error/Alert Dialog
    //Main Message
    private string ModalError { get; set; } = "";
    private string ErrorModalHeaderContent { get; set; } = "";
    private bool ErrorDialogIsVisible { get; set; } = false;

    private void OnOverlayclick(Microsoft.AspNetCore.Components.Web.MouseEventArgs arg)
    {
        this.ErrorDialogIsVisible = false;
    }

    private void CloseDialog()
    {
        this.ErrorDialogIsVisible = false;
    }

    #endregion

    //SfGrid No. 1 Methods
    #region SfGrid methods and settings

    //Grid Object for costum actions
    SfGrid<K_Order> SfGrid;

    //LoadDataOrder objects for greed
    List<K_Order> GridNo1List = new List<K_Order>();



    //List KOrder for Multi AVG
    List<K_Order> selectedRows = new List<K_Order>();

    //AVGInput For Multu AVG
    int? MultiAVGInput { get; set; }

    //for preventing double send passport to db duplicate
    int PreventDuplicate;
    //for preventing double send passport to db duplicate on delete
    int PreventDuplicateWhenDelete;

    //list to compare after select pass grid
    List<K_Passport> k_PassportsForPassTableSelct;
    List<K_OrderPassports> K_OrderPassportsEditTable;


    //Command Button Clicked In grid
    public async void OnCommandClicked(CommandClickEventArgs<K_Order> args)
    {
        PreventDuplicate = 0;
        PreventDuplicateWhenDelete = 0;

        if (args.CommandColumn.ButtonOption.Content == "בחירת פספורט")
        {
            if (!KOrdersfunctions.IsKOrderPickPassGidulZanSet(args.RowData))
            {
                ErrorDialogIsVisible = true;
                ErrorModalHeaderContent = "שגיאה!";
                ModalError = "יש לבחור גידול וזן מתאימים!";
            }
            else
            {
                kOrderPassports = new List<K_OrderPassports>();
                k_PassportsForKOrderPassportsUpdate = new List<K_Passport>();
                K_OrderForPickPassport = args.RowData;
                PickPassForKorderModalBool = true;
                LoadingSpinner = true;

                await GetKpassportsForKorder(args.RowData);


                if (K_OrderForPickPassport.K_OrderPassports.Count() > 0)
                {
                    foreach (var kordpas in K_OrderForPickPassport.K_OrderPassports)
                    {
                        await Task.Run(() => kOrderPassports.Add(kordpas));

                    }
                }
                LoadingSpinner = false;
                StateHasChanged();

            }
        }
    }

    //Syncfusion RowSelect Way
    public async Task RowSelected(RowSelectEventArgs<K_Order> args)
    {
        selectedRows = SfGrid.SelectedRecords;
    }
    //Syncfusion RowSelect Way
    public async Task RowDeSelected(RowDeselectEventArgs<K_Order> args)
    {
        selectedRows = SfGrid.SelectedRecords;
    }

    //delivery note functions
    async void SetIsDeliveryNote(int isOn)
    {
        LoadingSpinner = true;

        var listKorder = await SfGrid.GetSelectedRecords();
        if (listKorder.Count() == 0)
        {
            ErrorDialogIsVisible = true;
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "לא נבחרו עבודות!";
            LoadingSpinner = false;
            return;
        }
        try
        {
            foreach (var order in listKorder)
            {
                if (isOn == 0)
                {
                    order.IsDeliveryNote = true;
                }
                else
                {
                    order.IsDeliveryNote = false;
                }
                await Http.PutAsJsonAsync($"api/WeeklyKOrder/UpdateTodayTomorrowOrder/{order.JobId}", order);
            }
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
            if (IsConnected) await SendMessage();
            ToastContent = e.Message;
            StateHasChanged();
            await ShowToast();
            LoadingSpinner = false;

        }

        if (IsConnected) await SendMessage();
        ToastContent = "נשמר!";
        StateHasChanged();
        await ShowToast();
        MultiAVGInput = null;
        LoadingSpinner = false;

    }

    //BARTENDER PRINT / UNPRINT
    async void SentToBartenderPrint(int Isprint = 0)
    {
        LoadingSpinner = true;

        var listKorder = await SfGrid.GetSelectedRecords();
        if (listKorder.Count() == 0)
        {
            ErrorDialogIsVisible = true;
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "לא נבחרו עבודות!";
            LoadingSpinner = false;
            return;
        }
        try
        {
            //if print
            if (Isprint == 0)
            {

                foreach (var order in listKorder)
                {
                    if (order.JobStatus == K_OrderPhase.AttachedPassports || order.JobStatus == K_OrderPhase.Finish)
                    {
                        order.IsPrinted = true;
                        order.JobStatus = K_OrderPhase.InProgress;
                        order.NumOfBarTenderStickers = KOrdersfunctions.GetNumOfBarTenderStickers(order);
                        await Http.PutAsJsonAsync($"api/WeeklyKOrder/UpdateTodayTomorrowOrder/{order.JobId}", order);
                    }
                    else
                    {
                        continue;
                    }
                }

            }
            //IF CANCEL PRINT
            else
            {
                foreach (var kord in listKorder)
                {
                    if (kord.JobStatus != K_OrderPhase.InProgress) { continue; }

                    kord.IsPrinted = false;
                    kord.JobStatus = K_OrderPhase.AttachedPassports;
                    await Http.PutAsJsonAsync($"api/WeeklyKOrder/UpdateTodayTomorrowOrder/{kord.JobId}", kord);
                }

            }
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
            //if (IsConnected) await SendMessage();
            ToastContent = e.Message;
            await ShowToast();
            StateHasChanged();
            MultiAVGInput = null;
            LoadingSpinner = false;
        }


        ToastContent = "נשמר!";
        await ShowToast();
        MultiAVGInput = null;
        LoadingSpinner = false;
        //StateHasChanged();
        if (IsConnected) await SendMessage();

    }
    //prop for multiDate
    DateTime? MultiDate { get; set; }

    //Multi Job Is done
    async void BtnSemdMultiJobIsDone()
    {
        if (selectedRows.Count() == 0)
        {
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "לא נבחרו עבודות!";
            ErrorDialogIsVisible = true;
            return;
        }

        LoadingSpinner = true;
        await SendMultiJobIsDone();
        ToastContent = "נשמר!";

        LoadingSpinner = false;
        await ShowToast();
        //StateHasChanged();
        if (IsConnected) await SendMessage();
    }
    //Multi Job Is done DB
    async Task<int> SendMultiJobIsDone()
    {
        foreach (var order in selectedRows)
        {
            try
            {
                if (order.JobStatus == K_OrderPhase.Finish)
                {
                    continue;
                }
                else if (order.JobStatus != K_OrderPhase.InProgress)
                {
                    continue;
                }
                else
                {
                    foreach (var pass in order.K_OrderPassports)
                    {
                        pass.K_Passport.IsNeedToBeChecked = true;
                        await Http.PutAsJsonAsync($"api/KPassports/SetKPassportNeedToCheckON/{pass.K_PassportId}", pass.K_Passport);

                    }
                }

                order.JobStatus = K_OrderPhase.Finish;
                order.IsPrinted = false;
                var rslt = await Http.PutAsJsonAsync($"api/WeeklyKOrder/UpdateTodayTomorrowOrder/{order.JobId}", order);

                if (rslt.IsSuccessStatusCode)
                {
                    continue;
                }
                else
                {
                    ToastContent = await rslt.Content.ReadAsStringAsync();
                    StateHasChanged();
                    await ShowToast();
                }
            }
            catch (Exception e)
            {
                Console.WriteLine(e.Message);
                ModalError = e.Message;
                ErrorDialogIsVisible = true;
            }
        }
        return 0;
    }
    //Multi jobs cancel BTN
    void BtnCancelJobs()
    {
        if (selectedRows.Count() == 0)
        {
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "לא נבחרו עבודות!";
            ErrorDialogIsVisible = true;
            return;
        }
        IsListOfCancelJobs = true;
        CancelKorderShow = true;
    }
    async void SencListJobsCancel()
    {
        if (String.IsNullOrEmpty(TboxCancel) || String.IsNullOrEmpty(WhoCancel))
        {
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "יש למלא את שתי האופציות!";
            ErrorDialogIsVisible = true;
            return;
        }
        LoadingSpinner = true;
        KorderCancelHide();
        await CancelJobsDB(selectedRows);
        IsListOfCancelJobs = false;
        LoadingSpinner = false;
        if (IsConnected) await SendMessage();
        return;
    }
    async Task<int> CancelJobsDB(List<K_Order> selectedRows)
    {
        foreach (var row in selectedRows)
        {
            try
            {
                K_OrderForEdit = row;
                K_OrderRemark.JobId = K_OrderForEdit.JobId;
                K_OrderRemark.Remark = $"ביטול עבודה-מי ביטל: {WhoCancel} סיבת ביטול:{TboxCancel}";
                if (K_OrderForEdit.IsDeliveryNote == true) { K_OrderForEdit.IsWasChangedAfterDeliveryReport = true; }

                if (K_OrderForEdit.K_OrderPassports.Count() > 0)
                {
                    K_OrderForEdit.IsPrinted = false;
                }
                else
                {
                    K_OrderForEdit.JobStatus = K_OrderPhase.Canceled;
                }
                K_OrderForEdit.IsJobCancel = true;
                await Http.PostAsJsonAsync(("api/WeeklyKOrder/NewKOrderRemark"), K_OrderRemark);
                await Http.PutAsJsonAsync($"api/WeeklyKOrder/UpdateTodayTomorrowOrder/{K_OrderForEdit.JobId}", K_OrderForEdit);
                K_OrderRemark = new K_OrderRemark();

            }
            catch (Exception e)
            {
                Console.WriteLine(e.Message);
                continue;
            }
        }
        return 0;
    }
    //Multi Change Date
    async void BtnSendMultiDate()
    {
        if (selectedRows.Count() == 0)
        {
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "לא נבחרו עבודות!";
            ErrorDialogIsVisible = true;
            return;
        }
        //if MarketDate < Today
        var md = Convert.ToDateTime(MultiDate).Subtract(DateTime.Today).TotalDays;
        if (md < 0)
        {
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "תאריך הוצאה חייב להיות עתידי!";
            ErrorDialogIsVisible = true;
            return;
        }
        LoadingSpinner = true;
        await SendMultiDateRows();
        if (IsConnected) await SendMessage();
        ToastContent = "נשמר!";
        StateHasChanged();
        LoadingSpinner = false;
        await ShowToast();
        MultiAVGInput = null;
    }
    //Multi Date Send to DB
    async Task<int> SendMultiDateRows()
    {
        foreach (var order in selectedRows)
        {
            try
            {
                order.MarketingDate = MultiDate;
                var rslt = await Http.PutAsJsonAsync($"api/WeeklyKOrder/UpdateTodayTomorrowOrder/{order.JobId}", order);

                if (rslt.IsSuccessStatusCode)
                {
                    continue;
                }
                else
                {
                    ToastContent = await rslt.Content.ReadAsStringAsync();
                    StateHasChanged();
                    await ShowToast();
                }
            }
            catch (Exception e)
            {
                Console.WriteLine(e.Message);
                ModalError = e.Message;
                ErrorDialogIsVisible = true;
            }
        }
        return 0;
    }


    //MULTI AVG BTN CLICK
    async void BtnSendMultiAVG()
    {
        if (selectedRows.Count() == 0)
        {
            ErrorDialogIsVisible = true;
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "לא נבחרו עבודות!";
        }
        else if (MultiAVGInput == null || MultiAVGInput == 0)
        {
            ErrorDialogIsVisible = true;
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "לא הוזן ערך לממוצע כולל!";
        }
        else if (MultiAVGInput < 0)
        {
            ErrorDialogIsVisible = true;
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "לא ניתן להזין ערך שלילי!";
        }
        else
        {
            LoadingSpinner = true;
            await SendMultiAVGRows();
            LoadingSpinner = false;

        }

    }

    //MULTI AVG Rows Sent
    async Task<int> SendMultiAVGRows()
    {
        foreach (var order in selectedRows)
        {
            try
            {
                if ((order.JobPlantsNum == null || order.JobPlantsNum == 0) && order.JobNumOfMagash <= 0)
                {
                    ErrorDialogIsVisible = true;
                    ErrorModalHeaderContent = "שגיאה!";
                    ModalError = $"לא ניתן לחשב מגשים לעבודה {order.CxName + " " + order.Gidul + " " + order.Zan}!";
                    return 1;
                }
                else if ((order.JobPlantsNum == null || order.JobPlantsNum == 0) && order.JobNumOfMagash > 0)
                {
                    order.JobPlantsNum = MultiAVGInput * order.JobNumOfMagash;
                }
                else
                {
                    KOrdersfunctions.SetAvgForKorder(Convert.ToDouble(MultiAVGInput), order);
                }
                order.JobPlansAvarage = MultiAVGInput;
                var rslt = await Http.PutAsJsonAsync($"api/WeeklyKOrder/UpdateTodayTomorrowOrder/{order.JobId}", order);

                if (rslt.IsSuccessStatusCode)
                {
                    continue;
                }
                else
                {
                    ToastContent = await rslt.Content.ReadAsStringAsync();
                    StateHasChanged();
                    await ShowToast();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message);
                ModalError = ex.Message;
                ErrorDialogIsVisible = true;

            }

        }

        if (IsConnected) await SendMessage();
        ToastContent = "נשמר!";
        StateHasChanged();
        await ShowToast();
        MultiAVGInput = null;

        return 0;
    }

    //On double click Open
    public async void RecordDoubleClickHandler(RecordDoubleClickEventArgs<K_Order> args)
    {
        K_OrderForEdit = args.RowData;
        RowEditDialogShow = true;
        K_OrderForAllEdit.Gidul = args.RowData.Gidul;
        K_OrderForAllEdit.Zan = args.RowData.Zan;
        K_OrderForAllEdit.JobNumOfMagash = args.RowData.JobNumOfMagash;
        K_OrderForAllEdit.JobPlantsNum = args.RowData.JobPlantsNum;
        K_OrderForAllEdit.JobPlansAvarage = args.RowData.JobPlansAvarage;
        K_OrderForAllEdit.HamamaRemarks = args.RowData.HamamaRemarks;
        AVGAutoCalc = "";
    }

    //Nullble DateTime To Short Date String
    string DateTimeToShortString(DateTime? dateTime)
    {
        DateTime date = Convert.ToDateTime(dateTime);
        var shortDate = date.ToShortDateString();
        return shortDate;
    }

    //button clear filter
    public async void ClearGridfilter()
    {
        await this.SfGrid.ClearFiltering();
    }

    //clear search box
    public void ClearGridSearch()
    {
        try
        {
            this.SfGrid.Search("");
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
        }

    }
    public async void SendPassportPost()
    {


       
        await Http.PostAsJsonAsync($"api/Android/KPassport/PostKPassport", k_Passport);
    }

    public IEditorSettings CustomerEditParams = new StringEditCellParams
    {
        Params = new TextBoxModel() { EnableRtl = true, ShowClearButton = false, Multiline = true }
    };
    #endregion

    //Pick Passports
    #region Pick Passports

    //Grid Obj
    SfGrid<K_Passport> SfGridKpassport;



    //PICK Pass for jobs
    List<K_Passport> k_PassportsForKorder { get; set; }

    //Passports To KOrder Obj
    List<K_OrderPassports> kOrderPassports { get; set; } = new List<K_OrderPassports>();

    K_OrderPassports korderPassport { get; set; } = new K_OrderPassports();

    K_Passport chosenKPassport { get; set; } = new K_Passport();
    //KPassports for KOrderPassports UPDATE
    List<K_Passport> k_PassportsForKOrderPassportsUpdate { get; set; }

    //KOrder Obj for pick passport
    K_Order K_OrderForPickPassport { get; set; } = new K_Order();

    //input to search Zan
    string SearchByZan;

    private bool PickPassForKorderModalBool { get; set; } = false;

    //int to check edit on korderpassports
    int? KorderPassport { get; set; }

    decimal? temp;
    int startAvg;

    //for tooltip
    string GidZanToolContentContent = "בעת הטעינה הראשונית נבחרים פספורטים לפי קוד פריט(תוצאה מדויקת יותר). בחירה באופציה זו נצרכת כאשר בדכ, רוצים לערבב מגשים בעלי גודל שונה.";

    //send kordPassport
    async void SendKorderPassport(K_OrderPassports k_OrderPassports)
    {
        LoadingSpinner = true;
        try
        {
            await Http.PostAsJsonAsync("api/WeeklyKOrder/NewKOrderPassport", k_OrderPassports);
            K_OrderForPickPassport = await Http.GetFromJsonAsync<K_Order>($"api/WeeklyKOrder/GetKOrder/Thai/{k_OrderPassports.JobId}");
            kOrderPassports = new List<K_OrderPassports>();

            foreach (var kordpas in K_OrderForPickPassport.K_OrderPassports)
            {
                await Task.Run(() => kOrderPassports.Add(kordpas));

            }
            ToastContent = "נשמר!";


            await ShowToast();
            //StateHasChanged();
            if (IsConnected) await SendMessage();
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
            //if (IsConnected) await SendMessage();
            ToastContent = e.Message;
            StateHasChanged();
            await ShowToast();
        }

        LoadingSpinner = false;
    }
    //delete korderPassport
    async void DeleteKorderPassport(K_OrderPassports k_OrderPassports)
    {
        //if we have only 1 oblect in kOrderPassports list we have to delete via main btn to change job status
        if (kOrderPassports.Count() == 1)
        {
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "נא למחוק את העבודה דרך כפתור מחיקה ראשי";
            ErrorDialogIsVisible = true;
            PreventDuplicateWhenDelete = 0;
            PreventDuplicate = 0;
            return;
        }

        //if no find kpassport
        var kpassport = k_PassportsForKorder.Where(x => x.K_PassportId == k_OrderPassports.K_PassportId).FirstOrDefault();
        if (kpassport == null)
        {
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "פספורט נעול לשינויים! נא ליצור קשר עם Admin!";
            ErrorDialogIsVisible = true;

            return;
        }
        //set kPassport magash before delete
        kpassport.MagashAmount += k_OrderPassports.PassportMagashAmpunt;
        //for kPassport Auditform
        PassportAuditForm passportAuditForm = new PassportAuditForm();
        passportAuditForm.K_PassportId = kpassport.K_PassportId;
        passportAuditForm.CreateDate = DateTime.Now;
        passportAuditForm.AuditStatus = "החזרת כמות";
        passportAuditForm.Remark = $"לקוח: {K_OrderForPickPassport.CxName}.";
        kOrderPassports.Remove(k_OrderPassports);
        SfGridKpassport.Refresh();
        LoadingSpinner = true;
        try
        {
            await Http.DeleteAsync($"api/WeeklyKOrder/KOrderPassportDelete/{k_OrderPassports.PassportsToOrdersId}");
            await Http.PutAsJsonAsync($"api/KPassports/{kpassport.K_PassportId}", kpassport);
            if (IsConnected) await SendMessage();
            ToastContent = "נשמר!";
            StateHasChanged();
            await ShowToast();
        }

        catch (Exception e)
        {
            Console.WriteLine(e.Message);
            Console.WriteLine(e.Message);
            if (IsConnected) await SendMessage();
            ToastContent = e.Message;
            StateHasChanged();
            await ShowToast();
        }
        LoadingSpinner = false;
    }

    //after update selected passport and send
    async void UpdateKorderPassport(K_OrderPassports k_OrderPassports)
    {

        if (k_OrderPassports.MagashMiddle == 0 || k_OrderPassports.MagashMiddle < 0)
        {

            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "ערך לא חוקי!";
            ErrorDialogIsVisible = true;

            return;
        }

        //if no find kpassport
        var kpassport = k_PassportsForKorder.Where(x => x.K_PassportId == k_OrderPassports.K_PassportId).FirstOrDefault();
        if (kpassport == null)
        {
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "פספורט נעול לשינויים! נא ליצור קשר עם Admin!";
            ErrorDialogIsVisible = true;
            return;
        }

        LoadingSpinner = true;


        //If After update magash < Before update magash
        if (k_OrderPassports.MagashMiddle < k_OrderPassports.PassportMagashAmpunt)
        {
            kpassport.MagashAmount += (k_OrderPassports.PassportMagashAmpunt - k_OrderPassports.MagashMiddle);

            SfGridKpassport.Refresh();
        }
        //If After update magash > Before update magash
        else
        {
            if (kpassport.MagashAmount >= (k_OrderPassports.MagashMiddle - k_OrderPassports.PassportMagashAmpunt))
            {
                kpassport.MagashAmount -= (k_OrderPassports.MagashMiddle - k_OrderPassports.PassportMagashAmpunt);
            }
            //if not enough magash
            else
            {
                ErrorModalHeaderContent = "שגיאה!";
                ModalError = "אין מספיק מגשים בפספורט!";
                ErrorDialogIsVisible = true;
                SfGridKpassport.Refresh();
                return;
            }
        }
        try
        {
            await Http.PutAsJsonAsync($"api/KPassports/{kpassport.K_PassportId}", kpassport);
            k_OrderPassports.PassportMagashAmpunt = k_OrderPassports.MagashMiddle;
            await Http.PutAsJsonAsync($"api/WeeklyKOrder/UpdateKOrderPassport", k_OrderPassports);
            SfGridKpassport.Refresh();


            ToastContent = "נשמר!";
            await ShowToast();
            StateHasChanged();
            if (IsConnected) await SendMessage();
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
            //if (IsConnected) await SendMessage();
            ToastContent = e.Message;
            await ShowToast();
            StateHasChanged();

        }


        LoadingSpinner = false;
    }

    //SEND TO DB BTN
    async void BtnSendKOrderPassportsToDB(int dbAction = 0)
    {

        LoadingSpinner = true;

        switch (dbAction)
        {
            //Btn Send
            case 3:
                if (kOrderPassports.Count() == 0)
                {
                    ErrorModalHeaderContent = "שגיאה!";
                    ModalError = "לא נבחרו פספורטים!";
                    ErrorDialogIsVisible = true;
                    LoadingSpinner = false;

                    return;
                }
                PreventDuplicate++;

                if (PreventDuplicate > 1)
                {
                    ErrorModalHeaderContent = "שגיאה!";
                    ModalError = "הוראה נשלחה. נא להמתין בסבלנות";
                    ErrorDialogIsVisible = true;
                    return;
                }
                await SendKOrderPassportsToDB(3);

                break;
            //Btn Delete
            case 4:
                LoadingSpinner = false;

                ActionDialogHeader = "אזהרת מחיקה!";
                ActionDialogText = "האם למחוק את כל הפספורטים המצוותים לעבודה זו?";
                DialogVisability = true;
                return;
            case 5:
                break;
        }



        ToastContent = "נשמר!";
        await ShowToast();
        LoadingSpinner = false;
        StateHasChanged();
        if (IsConnected) await SendMessage();
    }

    //DB SEND LOGIC
    async Task<int> SendKOrderPassportsToDB(int action = 0)
    {

        switch (action)
        {
            //Btn Send
            case 3:
                //INSERT NEW List
                foreach (var korderpass in kOrderPassports)
                {
                    try
                    {
                        k_PassportsForKOrderPassportsUpdate.Add(k_PassportsForKorder.Where(x => x.K_PassportId == korderpass.K_PassportId).FirstOrDefault());
                    }
                    catch (Exception e)
                    {
                        Console.WriteLine(e.Message);
                    }
                    await Http.PostAsJsonAsync("api/WeeklyKOrder/NewKOrderPassport", korderpass);
                }
                K_OrderForPickPassport.JobStatus = K_OrderPhase.AttachedPassports.Trim();
                var rslt = await Http.PutAsJsonAsync($"api/WeeklyKOrder/UpdateTodayTomorrowOrder/{K_OrderForPickPassport.JobId}", K_OrderForPickPassport);

                if (!rslt.IsSuccessStatusCode)
                {
                    ErrorModalHeaderContent = "שגיאה!";
                    ModalError = rslt.ReasonPhrase; ;
                    ErrorDialogIsVisible = true;
                    LoadingSpinner = false;
                    StateHasChanged();
                }
                K_OrderForPickPassport = await Http.GetFromJsonAsync<K_Order>($"api/WeeklyKOrder/GetKOrder/Thai/{K_OrderForPickPassport.JobId}");
                kOrderPassports = new List<K_OrderPassports>();

                foreach (var kordpas in K_OrderForPickPassport.K_OrderPassports)
                {
                    await Task.Run(() => kOrderPassports.Add(kordpas));

                }
                var distictList2 = k_PassportsForKOrderPassportsUpdate.Distinct();

                //UPDATE KPassport magash
                foreach (var kpasport in distictList2)
                {
                    PassportAuditForm passportAuditForm = new PassportAuditForm();
                    passportAuditForm.K_PassportId = kpasport.K_PassportId;
                    passportAuditForm.CreateDate = DateTime.Now;
                    passportAuditForm.AuditStatus = "הורדת כמות";
                    passportAuditForm.Remark = $"לקוח: {K_OrderForPickPassport.CxName}. כ.מגש כוללת: {K_OrderForPickPassport.JobNumOfMagash} ";

                    await Http.PutAsJsonAsync($"api/KPassports/{kpasport.K_PassportId}", kpasport);
                    await Http.PostAsJsonAsync("api/PassportAuditForm", passportAuditForm);
                }
                break;
            //Btn Delete
            case 4:

                foreach (var korderpass in kOrderPassports)
                {
                    try
                    {
                        var kpassport = k_PassportsForKorder.Where(x => x.K_PassportId == korderpass.K_PassportId).FirstOrDefault();
                        if (kpassport == null)
                        {
                            ErrorModalHeaderContent = "שגיאה!";
                            ModalError = "פספורט לא פרוס כבר במצאי-נא לסווג עבודה כ\'חזרה\'!";
                            ErrorDialogIsVisible = true;
                            return 1;
                        }
                        kpassport.MagashAmount += korderpass.PassportMagashAmpunt;
                        k_PassportsForKOrderPassportsUpdate.Add(kpassport);
                        PassportAuditForm passportAuditForm = new PassportAuditForm();
                        passportAuditForm.K_PassportId = kpassport.K_PassportId;
                        passportAuditForm.CreateDate = DateTime.Now;
                        passportAuditForm.AuditStatus = "החזרת כמות";
                        passportAuditForm.Remark = $"לקוח: {K_OrderForPickPassport.CxName}.";
                        await Http.PutAsJsonAsync($"api/KPassports/{kpassport.K_PassportId}", kpassport);
                        await Http.PostAsJsonAsync("api/PassportAuditForm", passportAuditForm);
                    }
                    catch (Exception e)
                    {
                        Console.WriteLine(e.Message);
                    }
                }
                try
                {
                    //Delete KOrderKpassports
                    var t = await Http.DeleteAsync($"api/WeeklyKOrder/KOrderPassportsDelete/{K_OrderForPickPassport.JobId}");
                }
                catch (Exception e)
                {
                    Console.WriteLine(e.Message);
                }




                K_OrderForPickPassport.JobStatus = K_OrderPhase.StandBy.Trim();

                K_OrderForPickPassport.IsPrinted = false;
                var StandByrslt = await Http.PutAsJsonAsync($"api/WeeklyKOrder/UpdateTodayTomorrowOrder/{K_OrderForPickPassport.JobId}", K_OrderForPickPassport);

                if (!StandByrslt.IsSuccessStatusCode)
                {
                    ErrorModalHeaderContent = "שגיאה!";
                    ModalError = StandByrslt.ReasonPhrase; ;
                    ErrorDialogIsVisible = true;
                    LoadingSpinner = false;
                    StateHasChanged();
                }
                break;
        }

        return 0;
    }

    //KorderPassport grid events
    public void ActionCompletedHandler(ActionEventArgs<K_OrderPassports> args)
    {
        if (args.RequestType == Syncfusion.Blazor.Grids.Action.BeginEdit)
        {
            KorderPassport = args.Data.PassportMagashAmpunt;
        }
        if (args.RequestType == Syncfusion.Blazor.Grids.Action.Delete)
        {
            var kpass = k_PassportsForKorder.Where(x => x.K_PassportId == args.Data.K_PassportId).FirstOrDefault();

            if (kpass == null)
            {
                return;
            }
            kpass.MagashAmount += args.Data.PassportMagashAmpunt;
            k_PassportsForPassTableSelct.Add(kpass);
            K_OrderPassportsEditTable.Add(args.Data);
            SfGridKpassport.Refresh();
            return;
        }
        if (args.RequestType == Syncfusion.Blazor.Grids.Action.Save)
        {

            if (args.Data.PassportMagashAmpunt == 0)

            {
                var kpassport = k_PassportsForKorder.Where(x => x.K_PassportId == args.Data.K_PassportId).FirstOrDefault();
                if (kpassport == null) { return; }
                kpassport.MagashAmount += KorderPassport;
                k_PassportsForPassTableSelct.Add(kpassport);
                SfGridKpassport.Refresh();
                return;
            }
            else if (args.Data.PassportMagashAmpunt < 0)
            {

                ErrorModalHeaderContent = "שגיאה!";
                ModalError = "לא ניתן להזין כמות מגשים שלילית!";
                ErrorDialogIsVisible = true;
                return;
            }
            //IF After update magash < Before update magash
            if (KorderPassport > args.Data.PassportMagashAmpunt)
            {
                var kpassport = k_PassportsForKorder.Where(x => x.K_PassportId == args.Data.K_PassportId).FirstOrDefault();
                if (kpassport == null) { return; }
                kpassport.MagashAmount += (KorderPassport - args.Data.PassportMagashAmpunt);
                k_PassportsForPassTableSelct.Add(kpassport);
                SfGridKpassport.Refresh();

            }
            //after update magash < before update magash
            if (KorderPassport < args.Data.PassportMagashAmpunt)
            {
                var index = kOrderPassports.FindIndex(x => x.K_PassportId == args.Data.K_PassportId);
                var kpassport = k_PassportsForKorder.Where(x => x.K_PassportId == args.Data.K_PassportId).FirstOrDefault();
                if (kpassport == null) { return; }
                //if still we have enoughe magash after update
                if (kpassport.MagashAmount > (args.Data.PassportMagashAmpunt - KorderPassport))
                {
                    kpassport.MagashAmount -= (args.Data.PassportMagashAmpunt - KorderPassport);
                    k_PassportsForPassTableSelct.Add(kpassport);
                }
                //if not enough magash
                else
                {
                    ErrorModalHeaderContent = "שגיאה!";
                    ModalError = "אין מספיק מגשים בפספורט!";
                    ErrorDialogIsVisible = true;
                    kOrderPassports[index].PassportMagashAmpunt = KorderPassport;
                    SfGridKpassport.Refresh();
                    return;
                }
                SfGridKpassport.Refresh();
            }

        }
    }

    //Command Button "+" when pick Kpassport
    public async void OnCommandClickedPickPassports(CommandClickEventArgs<K_Passport> args)
    {
        if (args.CommandColumn.ButtonOption.Content == "")
        {

            //StateHasChanged()
            chosenKPassport = args.RowData;
            LoadingSpinner = true;
            var o = await CalculateKPassportMagash(args.RowData);
            //SfGridKpassport.Refresh();
            LoadingSpinner = false;
            StateHasChanged();
        }
    }
    async Task<int> CalculateKPassportMagash(K_Passport chosenKPassport)
    {

        //if no avg,plants && magash set
        if (!KOrdersfunctions.IsKOrderCanPickPassIntAmountSet(K_OrderForPickPassport))
        {
            ErrorDialogIsVisible = true;
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "יש לתאם כ.מגשים, שתילים וממוצע על מנת לבחור פספורט!";
            LoadingSpinner = false;
            StateHasChanged();
            return 1;
        }
        //if 0 magas && trying to take
        else if (KOrdersfunctions.IsPassportEmpty(chosenKPassport))
        {
            ErrorDialogIsVisible = true;
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "לא ניתן לקחת מגשים מפספורט שנגמר!";
            LoadingSpinner = false;
            StateHasChanged();
            return 1;
        }
        int? kpassportAvarage = await Task.Run(() => KOrdersfunctions.GetKpassportAvg(chosenKPassport));

        //IF WE DO NOT have a Existing list
        if (kOrderPassports == null || kOrderPassports.Count == 0)
        {
            korderPassport.JobId = K_OrderForPickPassport.JobId;
            korderPassport.K_PassportNum = chosenKPassport.PassportNum;
            korderPassport.K_PassportId = chosenKPassport.K_PassportId;
            korderPassport.KpassportHamama = Convert.ToInt32(chosenKPassport.Hamama);
            korderPassport.KpassportGamlon = Convert.ToInt32(chosenKPassport.Gamlon);
            korderPassport.SelectedAVG = Math.Min(Convert.ToInt32(kpassportAvarage), Convert.ToInt32(K_OrderForPickPassport.JobPlansAvarage));
            //Check if KPassport.Magash > WorkTotalMagash(WTM)
            if (chosenKPassport.MagashAmount > K_OrderForPickPassport.JobNumOfMagash)
            {
                //update kpassport magash
                chosenKPassport.MagashAmount -= K_OrderForPickPassport.JobNumOfMagash;
                korderPassport.PassportMagashAmpunt = K_OrderForPickPassport.JobNumOfMagash;
                korderPassport.MagashToCompare = K_OrderForPickPassport.JobNumOfMagash;
            }
            //KPassport.Magash < WTM
            else
            {
                korderPassport.PassportMagashAmpunt = chosenKPassport.MagashAmount;
                korderPassport.MagashToCompare = chosenKPassport.MagashAmount;
                //then kpassport.magash = 0
                chosenKPassport.MagashAmount = 0;
            }

            //Adding korderpassport to list
            kOrderPassports.Add(korderPassport);
            SfGridKpassport.Refresh();



        }
        //IF WE have EXISTING LIST
        else
        {
            //If we have the selecting passport in that List
            if (KOrdersfunctions.CheckIfKpassInsideKordPassports(kOrderPassports, chosenKPassport))
            {
                //WTM - RTM
                var korderMinusToalMagashList = KOrdersfunctions.GetKorderMinusTotalMagashList(K_OrderForPickPassport, kOrderPassports);
                //index for list obj edit
                var index = kOrderPassports.FindIndex(x => x.K_PassportId == chosenKPassport.K_PassportId);
                //korderpassport obj for logic
                var korderpassportObj = kOrderPassports.Where(x => x.K_PassportId == chosenKPassport.K_PassportId).FirstOrDefault();

                //if WTM > LTM
                if (K_OrderForPickPassport.JobNumOfMagash > KOrdersfunctions.GetTotalMagashPassportList(kOrderPassports))
                {
                    //if kpassport.magash > RTM
                    if (chosenKPassport.MagashAmount > korderMinusToalMagashList)
                    {
                        //Updating the obj in the list
                        kOrderPassports[index].PassportMagashAmpunt += korderMinusToalMagashList;
                        kOrderPassports[index].MagashToCompare = kOrderPassports[index].PassportMagashAmpunt;
                        chosenKPassport.MagashAmount -= korderMinusToalMagashList;
                    }
                    //kpassport < RTM
                    else
                    {
                        kOrderPassports[index].PassportMagashAmpunt += chosenKPassport.MagashAmount;
                        kOrderPassports[index].MagashToCompare = kOrderPassports[index].PassportMagashAmpunt;

                        //then kpassport.magash = 0
                        chosenKPassport.MagashAmount = 0;
                    }
                }
                //WTM < LTM
                else
                {
                    //if we good with magash amount only add 1 at a time
                    kOrderPassports[index].PassportMagashAmpunt += 1;
                    kOrderPassports[index].MagashToCompare = kOrderPassports[index].PassportMagashAmpunt;
                    chosenKPassport.MagashAmount -= 1;

                }
                SfGridKpassport.Refresh();
            }
            //NO PASSPORT IN THE EXISTING LIST
            else
            {
                //WTM - RTM
                var korderMinusToalMagashList = KOrdersfunctions.GetKorderMinusTotalMagashList(K_OrderForPickPassport, kOrderPassports);

                korderPassport = new K_OrderPassports()
                {
                    JobId = K_OrderForPickPassport.JobId,
                    K_PassportNum = chosenKPassport.PassportNum,
                    K_PassportId = chosenKPassport.K_PassportId,
                    KpassportHamama = Convert.ToInt32(chosenKPassport.Hamama),
                    KpassportGamlon = Convert.ToInt32(chosenKPassport.Gamlon),
                    SelectedAVG = Math.Min(Convert.ToInt32(kpassportAvarage), Convert.ToInt32(K_OrderForPickPassport.JobPlansAvarage))
                };

                //IF WTM > List Total Magash(LTM)
                if (K_OrderForPickPassport.JobNumOfMagash > KOrdersfunctions.GetTotalMagashPassportList(kOrderPassports))
                {
                    //If kpassport.magash > Relative Total Magash(korder.magash - LTM)
                    if (chosenKPassport.MagashAmount > korderMinusToalMagashList)
                    {
                        //update kpassport magash
                        chosenKPassport.MagashAmount -= korderMinusToalMagashList;
                        korderPassport.PassportMagashAmpunt = korderMinusToalMagashList;
                        korderPassport.MagashToCompare = korderPassport.PassportMagashAmpunt;
                    }
                    //kpassport.magash < RTM
                    else
                    {
                        korderPassport.PassportMagashAmpunt = chosenKPassport.MagashAmount;
                        korderPassport.MagashToCompare = korderPassport.PassportMagashAmpunt;

                        //then kpassport.magash = 0
                        chosenKPassport.MagashAmount = 0;
                    }

                }
                //WTM < LTM
                else
                {
                    korderPassport.PassportMagashAmpunt = 1;
                    korderPassport.MagashToCompare = korderPassport.PassportMagashAmpunt;
                    chosenKPassport.MagashAmount -= 1;
                }

                //Adding korderpassport to list
                kOrderPassports.Add(korderPassport);
                SfGridKpassport.Refresh();
                //StateHasChanged();

            }
        }
        return 0;
    }
    async void GetKpassportsByGidulAndZan()
    {
        LoadingSpinner = true;
        if (kOrderPassports.Count() > 0)
        {
            ErrorDialogIsVisible = true;
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "נא למחוק פספורטים משויכים כדי להפעיל חיפוש זה!";
            LoadingSpinner = false;
            return;
        }
        await GetKpassportsForKorder(K_OrderForPickPassport, false, SearchByZan);

        LoadingSpinner = false;

        SfGridKpassport.Refresh();
        //if (IsConnected) await SendMessageForPickPassport();

    }

    //Get Passports By ItemCode
    async Task<int> GetKpassportsForKorder(K_Order k_Order, bool isItemcode = true, string setZan = null)
    {
        k_PassportsForKorder = new List<K_Passport>();


        //if (isItemcode == false && String.IsNullOrEmpty(SearchByZan))
        //{
        //    k_PassportsForKorder = await Http.GetFromJsonAsync<List<K_Passport>>($"api/KPassports/GetKPassportsForKOrderByGidulAndZan/{k_Order.Gidul}/{k_Order.Zan}");
        //}
        //else if (isItemcode == false && !String.IsNullOrEmpty(SearchByZan))
        //{
        //    k_PassportsForKorder = await Http.GetFromJsonAsync<List<K_Passport>>($"api/KPassports/GetKPassportsForKOrderByGidulAndZan/{k_Order.Gidul}/{SearchByZan}");
        //}
        //else
        //{
        //    k_PassportsForKorder = await Http.GetFromJsonAsync<List<K_Passport>>($"api/KPassports/GetKPassportsForKOrderByItemCode/{k_Order.ItemCode}");
        //}
        if (isItemcode)
        {
            k_PassportsForKorder = await Http.GetFromJsonAsync<List<K_Passport>>($"api/KPassports/GetKPassportsForKOrderByGidulZanLIKE/{k_Order.Gidul}/{k_Order.Zan}");

        }
        else
        {
            k_PassportsForKorder = await Http.GetFromJsonAsync<List<K_Passport>>($"api/KPassports/metzay");
        }
        //if (IsConnected) await SendMessageForPickPassport();
        //StateHasChanged();
        StateHasChanged();
        return 0;
    }


    //Design Pick Pass Grid Same AS Metzay

    //ROW IsNeedToBeAudit STYLE
    public void PickPassportsRowBound(RowDataBoundEventArgs<K_Passport> args)
    {
        if (args.Data.IsNeedToBeAudit == true)
        {
            args.Row.AddClass(new string[] { "is-need-to-be-audit" });
        }
        if (args.Data.IsNeedToBeAudit == true && args.Data.IsSavedForCx == true)
        {
            args.Row.AddClass(new string[] { "is-need-to-be-saved-audit" });
        }
        if (args.Data.IsSavedForCx == true)
        {
            args.Row.AddClass(new string[] { "is-need-to-be-saved" });
        }
        foreach (var kordPass in kOrderPassports)
        {
            if (args.Data.PassportNum == kordPass.K_PassportNum && args.Data.IsSavedForCx != true && args.Data.IsNeedToBeAudit != true)
            {
                args.Row.AddClass(new string[] { "is-need-to-show-kpassport-pick-selection" });
            }
        }

    }

    //CELL MAGASH TYPE STYLE
    public void CustomizeCell(QueryCellInfoEventArgs<K_Passport> args)
    {
        if (args.Column.Field == "CelsTray")
        {
            try
            {

                if (Convert.ToDouble(args.Data.CelsTray) == 180)
                {
                    args.Cell.AddClass(new string[] { "magash-180" });
                }
                else if (Convert.ToDouble(args.Data.CelsTray) == 187)
                {
                    args.Cell.AddClass(new string[] { "magash-187" });
                }
                else if (Convert.ToDouble(args.Data.CelsTray) == 442)
                {
                    args.Cell.AddClass(new string[] { "magash-442" });
                }
                else
                {
                    args.Cell.AddClass(new string[] { "magash-308" });
                }
            }
            catch (Exception e)
            {
                Console.WriteLine(e.Message);
                return;
            }
        }
        ////PASSPORT STYLE
        if (args.Column.Field == "PassportNum")
        {
            args.Cell.AddClass(new string[] { "passport" });
        }
        //LOW AVG
        if (args.Column.Field == "PassportAVG")
        {
            if (args.Data.IsLowAVG == true)
            {
                args.Cell.AddClass(new string[] { "is-low-avg" });
            }
        }

        //HAMAMA STYLE
        if (args.Column.Field == "Hamama")
        {
            if (args.Data.Hamama.Trim() == "1")
            {
                args.Cell.AddClass(new string[] { "hamama1" });
            }
            else if (args.Data.Hamama.Trim() == "2")
            {
                args.Cell.AddClass(new string[] { "hamama2" });
            }
            else if (args.Data.Hamama.Trim() == "3")
            {
                args.Cell.AddClass(new string[] { "hamama3" });
            }
            else if (args.Data.Hamama.Trim() == "4")
            {
                args.Cell.AddClass(new string[] { "hamama4" });
            }
            else if (args.Data.Hamama.Trim() == "5")
            {
                args.Cell.AddClass(new string[] { "hamama5" });
            }
            else if (args.Data.Hamama.Trim() == "6")
            {
                args.Cell.AddClass(new string[] { "hamama6" });
            }
            else if (args.Data.Hamama.Trim() == "7")
            {
                args.Cell.AddClass(new string[] { "hamama7" });
            }
            else if (args.Data.Hamama.Trim() == null)
            {
                args.Cell.AddClass(new string[] { "null" });
            }
        }
    }

    #endregion

    //Confirm KOrderPassports From DB
    #region Confirm KOrderPassports From DB
    /// <summary>
    /// Modal Props and actions
    /// </summary>

    //Action MODAL VISABILITY
    private bool DialogVisability { get; set; } = false;


    //Modal Custom Text
    private string ActionDialogHeader { get; set; } = "";
    private string ActionDialogText { get; set; } = "";


    //DIALOG Cut CONFIRMED
    public async void ConfirmCutYes(int selection = 0)
    {
        PreventDuplicateWhenDelete++;
        if (PreventDuplicateWhenDelete > 1)
        {
            ErrorModalHeaderContent = "שגיאה!";
            ModalError = "הוראה נשלחה. נא להמתין בסבלנות";
            ErrorDialogIsVisible = true;
            return;
        }
        try
        {
            LoadingSpinner = true;
            DialogVisability = false;
            PickPassForKorderModalBool = false;
            var ans = await SendKOrderPassportsToDB(4);
            if (ans != 0)
            {
                LoadingSpinner = false;
                return;
            }
            if (IsConnected) await SendMessage();
            ToastContent = "נשמר!";
            StateHasChanged();
            await ShowToast();
            LoadingSpinner = false;

        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
            LoadingSpinner = false;
        }
    }

    //DIALOG Destroy CANCEL
    public void ConfirmDestroyNo()
    {
        this.DialogVisability = false;
    }
    #endregion

    //GRID 2 SETTING
    #region GRID 2

    //Grid Object for costum actions
    SfGrid<K_Order> SfGridNo2;

    //List KOrder for Multi AVG
    List<K_Order> NeedToConfirmRecords = new List<K_Order>();



    #endregion

    //Grid Edit Modal
    #region Grid Edit Modal

    //KOrder Object for Edit Data
    K_Order K_OrderForEdit = new K_Order();

    //Public KOrder obj for check edit
    K_Order K_OrderForAllEdit { get; set; } = new K_Order();

    //AVG string for Auto calc num of magash
    string EditAVGAutoCalc = "";

    //cx marketing date Min limit
    public DateTime MinDate { get; set; } = new DateTime(DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day);

    //KOrder Job Status list
    List<string> KOrderStatusList = K_OrderStatus.GetKOrderStatus();

    // Property to control the row edit dialog.
    public bool RowEditDialogShow { get; set; } = false;

    //cancel Edit row Modal
    public void CancelRowEditDialogShow()
    {
        RowEditDialogShow = false;
    }

    async void SendRowEdit(K_Order k_Order)
    {

        RowEditDialogShow = false;
        LoadingSpinner = true;
        await UpdateEditRow(k_Order);
        LoadingSpinner = false;
    }

    //UPDATE Row
    public async Task<int> UpdateEditRow(K_Order k_Order)
    {
        try
        {
            if (k_Order.K_OrderPassports.Count() > 0 && k_Order.Gidul != K_OrderForAllEdit.Gidul && k_Order.Zan != K_OrderForAllEdit.Zan)
            {
                ErrorModalHeaderContent = "שגיאה!";
                ModalError = "לא ניתן לשנות גידול ו/או זן לאחר שירדו כמויות!";
                ErrorDialogIsVisible = true;

                return 1;
            }

            if (!String.IsNullOrEmpty(k_Order.Gidul) && !String.IsNullOrEmpty(k_Order.Zan))
            {
                try
                {
                    k_Order.ItemCode = k_PassportsForJobs.Where(x => x.Gidul == k_Order.Gidul && x.Zan == k_Order.Zan).Select(x => x.ItemCode).Distinct().FirstOrDefault();
                }
                catch (Exception e)
                {
                    Console.WriteLine(e.Message);
                    ErrorModalHeaderContent = "שגיאה!";
                    ModalError = "גידול וזן לא קיימים!";
                    ErrorDialogIsVisible = true;

                    return 1;

                }
                if (String.IsNullOrEmpty(k_Order.ItemCode))
                {
                    ErrorModalHeaderContent = "שגיאה!";
                    ModalError = "גידול וזן לא קיימים!";
                    ErrorDialogIsVisible = true;

                    return 1;
                }

            }
            //if changes where made after attached passports
            if (k_Order.K_OrderPassports.Count() > 0 && (K_OrderForAllEdit.JobNumOfMagash != k_Order.JobNumOfMagash || K_OrderForAllEdit.JobPlantsNum != k_Order.JobPlantsNum
                || K_OrderForAllEdit.JobPlansAvarage != k_Order.JobPlansAvarage || K_OrderForAllEdit.HamamaRemarks != k_Order.HamamaRemarks))
            {
                k_Order.WasEditAfterAttachedPassports = true;
            }
            //if we edit the order after delivery bill was out
            if (k_Order.IsDeliveryNote == true) { k_Order.IsWasChangedAfterDeliveryReport = true; }
            var rslt = await Http.PutAsJsonAsync($"api/WeeklyKOrder/UpdateTodayTomorrowOrder/{k_Order.JobId}", k_Order);

            if (rslt.IsSuccessStatusCode)
            {
                if (IsConnected) await SendMessage();
                ToastContent = "נשמר!";
                StateHasChanged();
                await ShowToast();
            }
            else
            {
                ToastContent = await rslt.Content.ReadAsStringAsync();
                StateHasChanged();
                await ShowToast();
            }
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
        }
        return 0;
    }


    //Giduz & Zan inputs
    void EditGidulMouseClick(Microsoft.AspNetCore.Components.Web.MouseEventArgs mouseEventArgs)
    {
        if (mouseEventArgs.Buttons == 1)
        {
            if (!String.IsNullOrEmpty(K_OrderForEdit.Zan))
            {
                try
                {
                    K_OrderForEdit.Gidul = k_PassportsForJobs.Where(x => x.Zan == K_OrderForEdit.Zan).Select(x => x.Gidul).Distinct().Single();

                }
                catch (Exception e)
                {
                    Console.WriteLine(e.Message);
                    Giduls = k_PassportsForJobs.Select(x => x.Gidul).Distinct().ToList();
                }
            }
        }
    }



    //After Pick Zan MouseClick
    void EditZanMouseClick(Microsoft.AspNetCore.Components.Web.MouseEventArgs mouseEventArgs)
    {
        if (mouseEventArgs.Buttons == 1)
        {
            try
            {
                if (!String.IsNullOrEmpty(K_OrderForEdit.Gidul))
                {
                    Zans = k_PassportsForJobs.Where(x => x.Gidul == K_OrderForEdit.Gidul).Select(x => x.Zan).Distinct().ToList();
                }
                else
                {
                    K_OrderForEdit.Gidul = k_PassportsForJobs.Where(x => x.Zan == K_OrderForEdit.Zan).Select(x => x.Gidul).Distinct().Single();
                }
            }
            catch (Exception e)
            {
                Console.WriteLine(e.Message);
                Zans = k_PassportsForJobs.Select(x => x.Zan).Distinct().ToList();
            }
        }
    }
    //AVG Input
    void EditOrderKeyDown(KeyboardEventArgs args)
    {

        try
        {
            var numList = new List<string>
    {
                "0","1","2","3","4","5","6","7","8","9"
            };
            if (numList.Contains(args.Key))
            {
                AVGAutoCalc += args.Key;
                var intAvg = Convert.ToInt32(AVGAutoCalc);
                var magash = K_OrderForEdit.JobPlantsNum / intAvg;
                K_OrderForEdit.JobNumOfMagash = magash;
                AutoPlantsCalc = K_OrderForEdit.JobPlantsNum.ToString();
                AutoMagashCalc = magash.ToString();
            }
            if (args.Code == "Backspace")
            {
                AVGAutoCalc = AVGAutoCalc.Remove(AVGAutoCalc.Length - 1, 1);
            }
            if (args.Code == "Delete")
            {
                AVGAutoCalc = "";
            }

        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
        }
    }

    #endregion

    #region TOAST
    //TOAST
    public SfToast ToastObj;
    private string ToastContent { get; set; } = "נשמר!";
    private async Task ShowToast()
    {
        await this.ToastObj.Show();
    }

    private async Task HideToast()
    {
        await this.ToastObj.Hide("All");
    }
    #endregion

    //Style GRID
    #region Grid Style Methods
    //ROW IsNeedToBeAudit STYLE
    public void RowBound(RowDataBoundEventArgs<K_Order> args)
    {
        if (args.Data.JobStatus == K_OrderPhase.AttachedPassports && args.Data.IsJobCancel != true && args.Data.WasEditAfterAttachedPassports != true)
        {
            args.Row.AddClass(new string[] { "is-attached-passports" });
        }
        if (args.Data.IsJobCancel == true)
        {
            args.Row.AddClass(new string[] { "is-job-cancel" });
        }
        if (args.Data.JobStatus == K_OrderPhase.Finish)
        {
            args.Row.AddClass(new string[] { "is-job-ready" });
        }
        if (args.Data.WasEditAfterAttachedPassports == true)
        {
            args.Row.AddClass(new string[] { "job-was-edit-after-passports" });
        }
    }
    //IsPrinted TYPE STYLE
    public void CustomizeCell(QueryCellInfoEventArgs<K_Order> args)
    {
        if (args.Column.Field == "CxName")
        {
            try
            {

                if (args.Data.IsPrinted == true && args.Data.JobStatus != K_OrderPhase.Finish)
                {
                    args.Cell.AddClass(new string[] { "is-printed" });
                }
            }
            catch (Exception e)
            {
                Console.WriteLine(e.Message);
            }
        }
        if (args.Column.Field == "JobPlansAvarage")
        {
            if ((args.Data.JobPlansAvarage > 442 || args.Data.JobPlansAvarage < 150) && args.Data.JobPlansAvarage != 0)
            {
                args.Cell.AddClass(new string[] { "is-avg-not-good" });
            }
        }

    }

    #endregion
}

<style>
    .job-was-edit-after-passports {
        background-color: darksalmon;
    }

    .is-job-ready {
        background-color: mediumseagreen;
    }

    .is-job-cancel {
        background-color: lightpink;
    }

    .is-attached-passports {
        background-color: lightsteelblue;
    }

    .schedule-was-ok {
        background-color: palegoldenrod
    }

    .schedule-was-cancel {
        background-color: lightpink
    }

    .e-toast-container .e-toast .e-toast-message .e-toast-content {
        color: white;
        font-size: 18px;
        font-weight: normal;
    }

    .e-toast-container .e-toast {
        background-color: black;
    }

    .magash-180 {
        background-color: plum;
    }

    .magash-187 {
        background-color: lightyellow;
    }

    .magash-442 {
        background-color: grey;
        font-weight: bold;
    }

    .magash-308 {
        background-color: darkseagreen;
        font-weight: bold;
    }

    .magash-250 {
        background-color: green;
        font-weight: bold;
    }

    .magash-210 {
        background-color: hotpink;
        font-weight: bold;
    }

    .magash-260 {
        background-color: rosybrown;
        font-weight: bold;
    }

    .passport {
        background-color: powderblue;
        font-weight: bold;
        color: red;
    }

    .null {
        background-color: antiquewhite;
        font-weight: bold;
    }

    .hamama1 {
        background-color: cornflowerblue;
        font-weight: bold;
    }

    .hamama2 {
        background-color: yellow;
        font-weight: bold;
    }

    .hamama3 {
        background-color: lightpink;
        font-weight: bold;
    }

    .hamama4 {
        background-color: darkseagreen;
        font-weight: bold;
    }

    .hamama5 {
        background-color: gray;
        font-weight: bold;
    }

    .hamama6 {
        background-color: cadetblue;
        font-weight: bold;
    }

    .hamama7 {
        background-color: palevioletred;
        font-weight: bold;
    }
    /*   GRID ROW STYLE*/
    .is-need-to-be-audit {
        background-color: orange;
    }

    .is-need-to-be-saved {
        background-color: deepskyblue;
    }

    .is-need-to-be-saved-audit {
        background-color: mediumpurple;
    }

    .is-low-avg {
        background-color: orangered;
    }

    .is-printed {
        background-color: yellow;
    }

    .is-avg-not-good {
        background-color: tomato;
    }

    .is-need-to-show-kpassport-pick-selection {
        background-color: lightgoldenrodyellow;
    }


    .e-plus-icon::before {
        content: '\e823';
    }
</style>
